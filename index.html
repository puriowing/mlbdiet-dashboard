
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ドジャース減量シーズン・ダッシュボード（完全統合＋食事明細）</title>
<style>
  :root{
    --ink:#111827; --muted:#6b7280; --border:#e5e7eb; --bg:#f9fafb; --card:#ffffff; --brand:#1f2937;
    --ok:#065f46; --warn:#92400e; --bad:#991b1b;
  }
  *{box-sizing:border-box}
  body{margin:0; color:var(--ink); background:var(--bg);
    font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
      "Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic", Meiryo, sans-serif;}
  .wrap{max-width:1100px; margin:20px auto; padding:0 14px;}
  header{margin:6px 0 16px;}
  h1{font-size:22px; margin:0 0 6px;}
  h2{font-size:16px; margin:0 0 8px}
  .muted{color:var(--muted); font-size:12px}
  .grid{display:grid; grid-template-columns: repeat(12,1fr); gap:14px;}
  .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; box-shadow:0 1px 2px rgba(0,0,0,.04);}
  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{padding:8px 10px; border-bottom:1px solid var(--border); text-align:left; white-space:nowrap}
  th{background:#f3f4f6; font-weight:600}
  .kvs{display:flex; gap:10px; flex-wrap:wrap}
  .kv{background:#f3f4f6; border:1px solid var(--border); border-radius:10px; padding:6px 10px; font-size:13px}
  .scroll{overflow-x:auto; -webkit-overflow-scrolling:touch;}
  .pill{display:inline-block; background:#eef2ff; color:#3730a3; border-radius:999px; padding:2px 8px; font-size:12px}

  .span-6{grid-column: span 6} .span-4{grid-column: span 4} .span-8{grid-column: span 8} .span-12{grid-column: span 12}

  @media (max-width: 768px){
    .grid{grid-template-columns: repeat(6,1fr); gap:10px;}
    .span-6,.span-4,.span-8,.span-12{grid-column: 1 / -1;}
    th,td{padding:8px 6px; font-size:13px}
    h1{font-size:20px} h2{font-size:15px}
  }
  .small{font-size:12px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  input{padding:8px; border:1px solid #d1d5db; border-radius:8px;}
  button{padding:8px 12px; border-radius:10px; border:1px solid var(--brand); background:var(--brand); color:#fff; cursor:pointer}
  button.ghost{background:#fff; color:var(--brand); border-color:#d1d5db}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ドジャース減量シーズン・ダッシュボード（完全統合＋食事明細）</h1>
      <div class="muted">Googleシート <code>games</code> を読み込み：打撃・栄養・試合結果／NL西スタンディング（実力重みシミュレーション）／タイトル争い／ターゲット評価／NEXT GAME／<b>食事明細</b> を表示。</div>
    </header>

    <section class="grid">
      <div class="card span-6">
        <h2>通算打撃成績</h2>
        <div class="kvs">
          <div class="kv">試合 <strong id="G">-</strong></div>
          <div class="kv">AB <strong id="AB">-</strong></div>
          <div class="kv">H <strong id="H">-</strong></div>
          <div class="kv">HR <strong id="HR">-</strong></div>
          <div class="kv">RBI <strong id="RBI">-</strong></div>
          <div class="kv">R <strong id="R">-</strong></div>
          <div class="kv">BB <strong id="BB">-</strong></div>
          <div class="kv">TB <strong id="TB">-</strong></div>
        </div>
        <div class="kvs" style="margin-top:8px">
          <div class="kv">AVG <strong id="AVG">.000</strong></div>
          <div class="kv">OBP <strong id="OBP">.000</strong></div>
          <div class="kv">SLG <strong id="SLG">.000</strong></div>
          <div class="kv">OPS <strong id="OPS">.000</strong></div>
        </div>
      </div>

      <div class="card span-6">
        <h2>栄養（直近日の合計）<span id="judgeBadge" class="pill" style="margin-left:6px;display:none"></span></h2>
        <div class="kvs">
          <div class="kv">kcal <strong id="KCAL">-</strong></div>
          <div class="kv">糖質 <strong id="CARB">-</strong></div>
          <div class="kv">P <strong id="PROT">-</strong></div>
          <div class="kv">F <strong id="FAT">-</strong></div>
        </div>
        <div id="judge" class="small" style="margin-top:8px;color:#6b7280">ターゲット設定に基づき、最新日の評価を表示します。</div>
      </div>

      <div class="card span-12">
        <h2>試合ログ（食事明細つき）</h2>
        <div class="scroll">
          <table id="gameLog">
            <thead>
              <tr>
                <th>日付</th><th>対戦相手</th><th>スコア</th><th>結果</th>
                <th>成績（AB-H HR RBI R BB）</th>
                <th>栄養(kcal/C/P/F)</th>
                <th>朝食</th><th>昼食</th><th>夕食</th><th>間食</th><th>飲酒</th>
                <th>コメント</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card span-4">
        <h2>ナ・リーグ西地区（Standings：実力重み付き）</h2>
        <div class="scroll">
          <table id="nlw">
            <thead><tr><th>順位</th><th>チーム</th><th>勝</th><th>敗</th><th>勝率</th><th>GB</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small muted">非LAD試合は、各球団の過去3年勝率（重み）で確率決定（決定論的乱数）。</div>
        <div class="small" style="margin-top:6px"><label><input id="simToggle" type="checkbox" checked> シミュレーションを有効にする</label></div>
      </div>

      <div class="card span-4">
        <h2>MLB タイトル争い（スター比較・演出）</h2>
        <div class="scroll">
          <table>
            <thead><tr><th>タイトル</th><th>順位</th><th>トップ選手</th><th>トップ値</th><th>あなた</th></tr></thead>
            <tbody>
              <tr><td>首位打者</td><td id="rankAVGPos">-</td><td id="rankAVGName">-</td><td id="rankAVGTop">-</td><td id="rankAVGYou">-</td></tr>
              <tr><td>本塁打王</td><td id="rankHRPos">-</td><td id="rankHRName">-</td><td id="rankHRTop">-</td><td id="rankHRYou">-</td></tr>
              <tr><td>打点王</td><td id="rankRBIPos">-</td><td id="rankRBIName">-</td><td id="rankRBITop">-</td><td id="rankRBIYou">-</td></tr>
              <tr><td>得点王</td><td id="rankRPos">-</td><td id="rankRName">-</td><td id="rankRTop">-</td><td id="rankRYou">-</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card span-4">
        <h2>ターゲット設定（1日）</h2>
        <div class="kvs">
          <div class="kv">kcal <input id="tCalLow" type="number" value="1900" style="width:90px">〜<input id="tCalHigh" type="number" value="2100" style="width:90px"></div>
          <div class="kv">糖質g <input id="tCarbLow" type="number" value="150" style="width:80px">〜<input id="tCarbHigh" type="number" value="200" style="width:80px"></div>
          <div class="kv">P目標g <input id="tProt" type="number" value="120" style="width:90px"></div>
          <div class="kv">脂質g <input id="tFatLow" type="number" value="50" style="width:80px">〜<input id="tFatHigh" type="number" value="60" style="width:80px"></div>
        </div>
        <div style="margin-top:8px">
          <button id="saveTargets">ターゲット保存</button>
          <button id="resetTargets" class="ghost" style="margin-left:8px">初期値</button>
        </div>
        <div class="small muted" style="margin-top:6px">設定はブラウザの localStorage に保存。</div>
      </div>

      <div class="card span-12">
        <h2>NEXT GAME（あすの対戦相手）</h2>
        <div style="display:flex;gap:8px">
          <input id="nextGame" placeholder="例：LAD @ SD（パドレス）" style="flex:1">
          <button id="saveNext" class="ghost">保存</button>
        </div>
      </div>
    </section>
  </div>

<script>
// ===== 基本設定 =====
const SHEET_ID = "1b3oO6nDY1d-jmP2cFchm7ld5PvKIr34vh0KXYYKxx8I"; // ← あなたのIDをセット
const SHEET_NAME = "games";
const REFRESH_SEC = 20;

// ▼ 実力重み（過去3年の勝率イメージ：必要に応じて調整可）
const TEAM_STRENGTH = {
  "ドジャース": 0.585,
  "ジャイアンツ": 0.520,
  "パドレス": 0.500,
  "Dバックス": 0.490,
  "ロッキーズ": 0.430,
};

// ===== GViz fetch =====
function gvizUrl(){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;
}
async function fetchSheet(){
  const res = await fetch(gvizUrl());
  const txt = await res.text();
  const m = txt.match(/setResponse\(([\s\S]*)\)/);
  if(!m) throw new Error("GViz応答の解析に失敗。公開設定・SHEET_ID・シート名(games)を確認してください。");
  const json = JSON.parse(m[1]);
  const cols = json.table.cols.map(c=>c.label || c.id);
  const rows = json.table.rows.map(r=>{
    const obj = {};
    cols.forEach((c,i)=>{
      const cell = r.c[i];
      obj[c] = cell ? ((cell.f ?? cell.v)) : null;
    });
    return obj;
  });
  return rows;
}

// ===== Util =====
function pct(w,l){ const g=w+l; return g? (Math.round((w/g)*1000)/1000).toFixed(3).padStart(5,'0') : ".000"; }
function gb(leaderW, leaderL, w, l){ const v=((leaderW-w)+(l-leaderL))/2; return v===0? "-" : v.toFixed(1); }
function normTeam(n){ if(!n) return null; const s=String(n).toLowerCase();
  if(s.includes("巨")||s.includes("ジャイ")) return "ジャイアンツ";
  if(s.includes("pad")||s.includes("パド")) return "パドレス";
  if(s.includes("d-back")||s.includes("dバッ")||s.includes("ari")||s.includes("dbacks")||s.includes("ダイア")) return "Dバックス";
  if(s.includes("rock")||s.includes("ロッ")) return "ロッキーズ";
  if(s.includes("dodg")||s.includes("ドジャ")) return "ドジャース";
  return n;
}
function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }
function seedFromString(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
function rng(seed){ let x=seed>>>0; return function(){ x^=x<<13; x^=x>>>17; x^=x<<5; return ((x>>>0)/4294967296);}}

// ===== 計算（実力重みで非LAD戦を決定） =====
function compute(rows, enableSim){
  let G=0,AB=0,H=0,HR=0,RBI=0,R=0,BB=0,TB=0; let lastK='-',lastC='-',lastP='-',lastF='-';
  const standings={"ドジャース":{w:0,l:0},"ジャイアンツ":{w:0,l:0},"パドレス":{w:0,l:0},"Dバックス":{w:0,l:0},"ロッキーズ":{w:0,l:0}};
  const logRows=[]; const datesSet=new Set();

  // 1) LAD戦：実データ反映
  rows.forEach(r=>{
    const date=r.date||r.Date||r.DATE; const opp=normTeam(r.opponent||r.Opponent||r.OPP);
    const ds=Number(r.dodgers_runs||r.Dodgers||r.ds||0); const os=Number(r.opp_runs||r.Opp||r.os||0);
    const res=r.result || (ds>os?'W':(ds<os?'L':'T'));
    const ab=Number(r.AB||r.ab||0); const h=Number(r.H||r.h||0); const hr=Number(r.HR||r.hr||0);
    const rbi=Number(r.RBI||r.rbi||0); const rr=Number(r.R||r.r||0); const bb=Number(r.BB||r.bb||0);
    let tb=Number(r.TB||r.tb||0); const kcal=r.kcal_total??r.kcal??'-'; const carb=r.carb_total??r.carb??'-';
    const prot=r.prot_total??r.prot??'-'; const fat=r.fat_total??r.fat??'-'; const comment=r.comment||'';
    // 追加：食事明細
    const breakfast=r.breakfast || r.BREAKFAST || r.Breakfast || "";
    const lunch=r.lunch || r.LUNCH || r.Lunch || "";
    const dinner=r.dinner || r.DINNER || r.Dinner || "";
    const snack=r.snack || r.SNACK || r.Snack || "";
    const drink=r.drink || r.DRINK || r.Drink || "";

    if(!tb||tb===0){tb=h+3*hr;}
    G+=1; AB+=ab; H+=h; HR+=hr; RBI+=rbi; R+=rr; BB+=bb; TB+=tb; lastK=kcal; lastC=carb; lastP=prot; lastF=fat;
    if(res==='W'){standings['ドジャース'].w++; if(standings[opp]) standings[opp].l++;}
    else if(res==='L'){standings['ドジャース'].l++; if(standings[opp]) standings[opp].w++;}
    logRows.push({date,opp,ds,os,res,ab,h,hr,rbi,rr,bb,kcal,carb,prot,fat,comment,breakfast,lunch,dinner,snack,drink});
    if(date) datesSet.add(String(date));
  });

  // 2) 非LAD試合：実力重みで確率決定（決定論的）
  if(enableSim){
    const dates=Array.from(datesSet).sort();
    const pool=['ジャイアンツ','パドレス','Dバックス','ロッキーズ'];
    dates.forEach(d=>{
      const todaysOpps=rows.filter(r=>String(r.date||r.Date||r.DATE)===d).map(r=>normTeam(r.opponent||r.Opponent||r.OPP));
      const remain=pool.filter(t=>!todaysOpps.includes(t));
      const r=rng(seedFromString(d+'|NLW|weighted'));

      // マッチング（安定シャッフル）
      const arr=remain.slice();
      for(let i=arr.length-1;i>0;i--){const j=Math.floor(r()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];}
      for(let i=0;i+1<arr.length;i+=2){
        const a=arr[i], b=arr[i+1];
        const wa=clamp(TEAM_STRENGTH[a]??0.5, 0.40, 0.65);
        const wb=clamp(TEAM_STRENGTH[b]??0.5, 0.40, 0.65);
        const pA = wa / (wa + wb);
        const toss = r();
        if(toss < pA){ standings[a].w++; standings[b].l++; }
        else         { standings[b].w++; standings[a].l++; }
      }
    });
  }

  const AVG=AB>0?(H/AB).toFixed(3):'.000'; const OBP=(AB+BB)>0?((H+BB)/(AB+BB)).toFixed(3):'.000';
  const SLG=AB>0?(TB/AB).toFixed(3):'.000'; const OPS=(parseFloat(OBP)+parseFloat(SLG)).toFixed(3);
  return {totals:{G,AB,H,HR,RBI,R,BB,TB,AVG,OBP,SLG,OPS,lastK,lastC,lastP,lastF},standings,logRows};
}

// ===== タイトル争い（演出） =====
function titleRanks(t){
  const youAVG = parseFloat(t.AVG);
  const youHR  = t.HR;
  const youRBI = t.RBI;
  const youR   = t.R;
  const avgLeaders = [{n:"ルイス・アラエス",v:0.340},{n:"ムーキー・ベッツ",v:0.330},{n:"フレディ・フリーマン",v:0.325},{n:"ホセ・アルトゥーベ",v:0.320}];
  const hrLeaders  = [{n:"アーロン・ジャッジ",v:45},{n:"大谷翔平",v:42},{n:"カイル・シュワーバー",v:40},{n:"マット・オルソン",v:38}];
  const rbiLeaders = [{n:"ラファエル・デバース",v:120},{n:"フアン・ソト",v:115},{n:"ヨルダン・アルバレス",v:110},{n:"ブライス・ハーパー",v:105}];
  const rLeaders   = [{n:"ロナルド・アクーニャJr.",v:120},{n:"コリー・シーガー",v:115},{n:"ムーキー・ベッツ",v:110},{n:"フアン・ソト",v:105}];

  function rank(pool, yourVal, isRate=false){
    const arr = pool.map(x=>x.v).concat([yourVal]).sort((a,b)=>b-a);
    const pos = arr.indexOf(yourVal)+1;
    const top = pool[0];
    return {pos, topName:top.n, topVal: isRate? top.v.toFixed(3) : top.v, you: isRate? (isNaN(yourVal)? ".000" : yourVal.toFixed(3)) : yourVal};
  }

  const rAvg = rank(avgLeaders, isNaN(youAVG)?0:youAVG, true);
  const rHr  = rank(hrLeaders, youHR, false);
  const rRbi = rank(rbiLeaders, youRBI, false);
  const rR   = rank(rLeaders, youR, false);

  document.getElementById("rankAVGPos").textContent = `${rAvg.pos}位`;
  document.getElementById("rankAVGName").textContent = avgLeaders[0].n;
  document.getElementById("rankAVGTop").textContent = rAvg.topVal;
  document.getElementById("rankAVGYou").textContent = rAvg.you;

  document.getElementById("rankHRPos").textContent = `${rHr.pos}位`;
  document.getElementById("rankHRName").textContent = hrLeaders[0].n;
  document.getElementById("rankHRTop").textContent = rHr.topVal;
  document.getElementById("rankHRYou").textContent = rHr.you;

  document.getElementById("rankRBIPos").textContent = `${rRbi.pos}位`;
  document.getElementById("rankRBIName").textContent = rbiLeaders[0].n;
  document.getElementById("rankRBITop").textContent = rRbi.topVal;
  document.getElementById("rankRBIYou").textContent = rRbi.you;

  document.getElementById("rankRPos").textContent = `${rR.pos}位`;
  document.getElementById("rankRName").textContent = rLeaders[0].n;
  document.getElementById("rankRTop").textContent = rR.topVal;
  document.getElementById("rankRYou").textContent = rR.you;
}

// ===== ターゲット設定（localStorage + 評価） =====
const LS_KEY_TARGETS = "dodgers_targets_v1";
function loadTargets(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY_TARGETS)) || {calLow:1900,calHigh:2100,carbLow:150,carbHigh:200,prot:120,fatLow:50,fatHigh:60}; }
  catch(e){ return {calLow:1900,calHigh:2100,carbLow:150,carbHigh:200,prot:120,fatLow:50,fatHigh:60}; }
}
function saveTargets(t){ localStorage.setItem(LS_KEY_TARGETS, JSON.stringify(t)); }
function fillTargets(t){
  document.getElementById("tCalLow").value=t.calLow;
  document.getElementById("tCalHigh").value=t.calHigh;
  document.getElementById("tCarbLow").value=t.carbLow;
  document.getElementById("tCarbHigh").value=t.carbHigh;
  document.getElementById("tProt").value=t.prot;
  document.getElementById("tFatLow").value=t.fatLow;
  document.getElementById("tFatHigh").value=t.fatHigh;
}
function judgeDay(tot,tgt){
  const kcal=parseFloat(tot.lastK)||0, carb=parseFloat(tot.lastC)||0, prot=parseFloat(tot.lastP)||0, fat=parseFloat(tot.lastF)||0;
  const badge = document.getElementById("judgeBadge");
  if(!kcal && !carb && !prot && !fat){ document.getElementById("judge").textContent="最新日の栄養が未入力です。"; badge.style.display="none"; return; }
  const msgs=[]; let good=0,bad=0;
  if(kcal<tgt.calLow){msgs.push(`エネルギー不足（${kcal} < ${tgt.calLow}kcal）`); bad++;}
  else if(kcal>tgt.calHigh){msgs.push(`エネルギー過多（${kcal} > ${tgt.calHigh}kcal）`); bad++;}
  else {msgs.push(`エネルギーOK（${kcal}kcal）`); good++;}

  if(carb<tgt.carbLow){msgs.push(`糖質少なめ（${carb} < ${tgt.carbLow}g）`); bad++;}
  else if(carb>tgt.carbHigh){msgs.push(`糖質多め（${carb} > ${tgt.carbHigh}g）`); bad++;}
  else {msgs.push(`糖質OK（${carb}g）`); good++;}

  if(prot<tgt.prot){msgs.push(`P不足（${prot} < ${tgt.prot}g）`); bad++;}
  else {msgs.push(`P OK（${prot}g）`); good++;}

  if(fat<tgt.fatLow){msgs.push(`脂質少なめ（${fat} < ${tgt.fatLow}g）`); bad++;}
  else if(fat>tgt.fatHigh){msgs.push(`脂質多め（${fat} > ${tgt.fatHigh}g）`); bad++;}
  else {msgs.push(`脂質OK（${fat}g）`); good++;}

  document.getElementById("judge").innerHTML = msgs.map(m=>`<div>${m}</div>`).join("");

  if(bad===0 && good>=3){ badge.textContent="◎ 達成"; badge.style.display="inline-block"; }
  else if(good>=2){ badge.textContent="△ もう一歩"; badge.style.display="inline-block"; }
  else{ badge.textContent="× 要調整"; badge.style.display="inline-block"; }
}

// ===== レンダリング =====
function render(totals, standings, logRows){
  ["G","AB","H","HR","RBI","R","BB","TB","AVG","OBP","SLG","OPS"].forEach(id=>{
    document.getElementById(id).textContent = totals[id] ?? "-";
  });
  document.getElementById("KCAL").textContent = totals.lastK ?? "-";
  document.getElementById("CARB").textContent = totals.lastC ?? "-";
  document.getElementById("PROT").textContent = totals.lastP ?? "-";
  document.getElementById("FAT").textContent  = totals.lastF ?? "-";

  // standings
  const teams = Object.keys(standings).map(n=>({name:n, ...standings[n]}));
  teams.sort((a,b)=>{
    const pa = a.w/(a.w+a.l||1), pb = b.w/(b.w+b.l||1);
    if(pb!==pa) return pb-pa;
    return (b.w - a.w) || (a.l - b.l);
  });
  const leader = teams[0];
  const tbody = document.querySelector("#nlw tbody"); tbody.innerHTML="";
  teams.forEach((t,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}位</td><td>${t.name}</td><td>${t.w}</td><td>${t.l}</td>
      <td>${pct(t.w,t.l)}</td><td>${gb(leader.w,leader.l,t.w,t.l)}</td>`;
    tbody.appendChild(tr);
  });

  // game log
  const logBody = document.querySelector("#gameLog tbody"); logBody.innerHTML="";
  logRows.slice().reverse().forEach(g=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${g.date||""}</td><td>${g.opp||""}</td><td>${g.ds}-${g.os}</td><td>${g.res}</td>
      <td>${g.ab}-${g.h} HR${g.hr} RBI${g.rbi} R${g.rr} BB${g.bb}</td>
      <td>${g.kcal||0}/${g.carb||0}/${g.prot||0}/${g.fat||0}</td>
      <td>${g.breakfast||""}</td><td>${g.lunch||""}</td><td>${g.dinner||""}</td><td>${g.snack||""}</td><td>${g.drink||""}</td>
      <td>${g.comment||""}</td>`;
    logBody.appendChild(tr);
  });

  // title ranks
  titleRanks(totals);

  // target judge
  judgeDay(totals, loadTargets());
}

// ===== 初期化 =====
let SIM_ENABLED = true;
async function refresh(){
  try{
    const rows = await fetchSheet();
    const {totals, standings, logRows} = compute(rows, SIM_ENABLED);
    render(totals, standings, logRows);
  }catch(e){
    console.error(e);
    alert("シートの読み込みに失敗：公開設定 / SHEET_ID / シート名(games) をご確認ください。");
  }
}
function init(){
  // Targets
  const t = loadTargets(); fillTargets(t);
  document.getElementById("saveTargets").addEventListener("click", ()=>{
    const t = {
      calLow: Number(document.getElementById("tCalLow").value||0),
      calHigh:Number(document.getElementById("tCalHigh").value||0),
      carbLow:Number(document.getElementById("tCarbLow").value||0),
      carbHigh:Number(document.getElementById("tCarbHigh").value||0),
      prot:   Number(document.getElementById("tProt").value||0),
      fatLow: Number(document.getElementById("tFatLow").value||0),
      fatHigh:Number(document.getElementById("tFatHigh").value||0),
    };
    saveTargets(t);
    refresh();
  });
  document.getElementById("resetTargets").addEventListener("click", ()=>{
    const def = {calLow:1900,calHigh:2100,carbLow:150,carbHigh:200,prot:120,fatLow:50,fatHigh:60};
    saveTargets(def); fillTargets(def); refresh();
  });

  // Sim toggle
  const simToggle=document.getElementById("simToggle");
  if(simToggle){ SIM_ENABLED = simToggle.checked; simToggle.addEventListener("change", ()=>{ SIM_ENABLED = simToggle.checked; refresh(); }); }

  // NEXT GAME memo
  const LS_KEY='dodgers_next_game_note';
  const v=localStorage.getItem(LS_KEY)||"";
  document.getElementById("nextGame").value = v;
  document.getElementById("saveNext").addEventListener("click", ()=>{
    localStorage.setItem(LS_KEY, document.getElementById("nextGame").value || "");
  });

  refresh();
  setInterval(refresh, REFRESH_SEC*1000);
}
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
