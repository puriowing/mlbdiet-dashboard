<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diet MLB Dashboard — NL West</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <header class="mb-6">
      <h1 class="text-2xl sm:text-3xl font-bold">Diet MLB Dashboard</h1>
      <p class="text-sm text-slate-600 mt-1">データ元：Googleシート <code>games</code>（Diet MLBスプレッドシート）</p>
    </header>

    <!-- 通算成績 ------------------------------->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-3">これまでの通算成績</h2>
      <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-9 gap-3 text-center">
        <div><div class="text-xs text-slate-500">AB</div><div id="agg-ab" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">H</div><div id="agg-h" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">AVG</div><div id="agg-avg" class="text-2xl font-semibold">.000</div></div>
        <div><div class="text-xs text-slate-500">HR</div><div id="agg-hr" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">RBI</div><div id="agg-rbi" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">R</div><div id="agg-r" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">BB</div><div id="agg-bb" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">SLG</div><div id="agg-slg" class="text-2xl font-semibold">.000</div></div>
        <div><div class="text-xs text-slate-500">OPS</div><div id="agg-ops" class="text-2xl font-semibold">.000</div></div>
      </div>
      <p class="text-xs text-slate-500 mt-2">※ OBPは「(H+BB)/(AB+BB)」、SLGは「TB/AB」、OPS=OBP+SLG。</p>
    </section>

    <!-- ランキング（打率・HR・打点） --------->
    <section class="mb-10">
      <h2 class="text-xl font-semibold mb-3">ランキング（打率 / HR / 打点）</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <div class="bg-white border rounded-xl p-4">
          <h3 class="font-semibold mb-2">打率</h3>
          <ol id="rank-avg" class="space-y-2 text-sm"></ol>
        </div>
        <div class="bg-white border rounded-xl p-4">
          <h3 class="font-semibold mb-2">HR</h3>
          <ol id="rank-hr" class="space-y-2 text-sm"></ol>
        </div>
        <div class="bg-white border rounded-xl p-4">
          <h3 class="font-semibold mb-2">打点</h3>
          <ol id="rank-rbi" class="space-y-2 text-sm"></ol>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-2">※ ランキングは「あなた」＋主要スター（<span class="font-semibold">ナ・リーグ</span>想定進行値）で比較表示します。</p>
    </section>

    <!-- ナ・リーグ西地区 順位表 -------------->
    <section class="mb-10">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-semibold">ナ・リーグ西地区の順位表</h2>
        <label class="text-sm inline-flex items-center gap-2">
          <input id="nlw-sim-toggle" type="checkbox" class="scale-110" checked />
          シミュレーション有効（期間：データ開始日〜今日）
        </label>
      </div>
      <div class="overflow-x-auto bg-white border rounded-xl">
        <table class="w-full text-sm" id="nlw-table">
          <thead>
            <tr class="bg-slate-100 text-slate-700">
              <th class="px-3 py-2 text-left">順位</th>
              <th class="px-3 py-2 text-left">チーム</th>
              <th class="px-3 py-2">勝</th>
              <th class="px-3 py-2">敗</th>
              <th class="px-3 py-2">勝率</th>
              <th class="px-3 py-2">GB</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="text-xs text-slate-500 mt-2">※ 実試合成績は取得していないため、チーム実力値を元に日別決定論で集計（LAD/SF/SD/ARI/COL）。</p>
    </section>

    <!-- 食事・運動ログ ------------------------>
    <section class="mb-10">
      <h2 class="text-xl font-semibold mb-3">これまでの食事・運動ログ</h2>
      <div class="overflow-x-auto bg-white border rounded-xl">
        <table class="w-full text-sm" id="log-table">
          <thead>
            <tr class="bg-slate-100 text-slate-700">
              <th class="px-3 py-2">日付</th>
              <th class="px-3 py-2">対戦相手</th>
              <th class="px-3 py-2">成績（AB-H HR RBI R BB）</th>
              <th class="px-3 py-2">栄養 (kcal/C/P/F)</th>
              <th class="px-3 py-2">朝食</th>
              <th class="px-3 py-2">昼食</th>
              <th class="px-3 py-2">夕食</th>
              <th class="px-3 py-2">間食</th>
              <th class="px-3 py-2">飲酒</th>
              <th class="px-3 py-2">運動</th>
              <th class="px-3 py-2">メモ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="text-xs text-slate-500 mt-2">※ 「運動」はコメント欄から簡易抽出（例：<code>バイク1時間</code>、<code>20秒×10</code>など）。</p>
    </section>

    <!-- フッター状態 ------------------------->
    <footer class="text-xs text-slate-500">
      SHEET: <span id="sheet-pill">未設定</span> ／ 状態: <span id="status-pill">読み込み中…</span>
    </footer>
  </div>

  <script>
    // ===== 基本設定 =====
    const CONFIG = {
      SHEET_ID: "1b3oO6nDY1d-jmP2cFchm7ld5PvKIr34vh0KXYYKxx8I",
      SHEET_NAME: "games",
      TIMEZONE: "Asia/Tokyo",
    };
    const $ = (q)=>document.querySelector(q);

    // ===== CSV取得 =====
    async function fetchCSV(){
      const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(CONFIG.SHEET_NAME)}`;
      const r = await fetch(url, {cache:"no-store"});
      if(!r.ok) throw new Error(`CSV HTTP ${r.status}`);
      return r.text();
    }

    // ===== CSVパース（ヘッダー正規化） =====
    function splitCSV(line){ const out=[]; let cur='',q=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else q=!q; } else if(ch===',' && !q){ out.push(cur); cur=''; } else { cur+=ch; } } out.push(cur); return out; }
    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(Boolean);
      if(!lines.length) return {header:[], rows:[]};
      const norm = s => (s||"").replace(/^\uFEFF/,'').trim().toLowerCase().replace(/[\s\-]+/g,'_');
      const MAP = {
        date:'date', opponent:'opponent', dodgers_runs:'dodgers_runs',
        opp_runs:'opp_runs', op_runs:'opp_runs', opponent_runs:'opp_runs',
        result:'result',
        ab:'AB', h:'H', hr:'HR', rbi:'RBI', r:'R', bb:'BB', tb:'TB',
        comment:'comment',
        kcal_total:'kcal_total', calories_total:'kcal_total',
        carb_total:'carb_total', carbohydrates_total:'carb_total',
        prot_total:'prot_total', protein_total:'prot_total',
        fat_total:'fat_total',
        breakfast:'breakfast', lunch:'lunch', dinner:'dinner', snack:'snack', drink:'drink'
      };
      const EXPECT = ['date','opponent','dodgers_runs','opp_runs','result','AB','H','HR','RBI','R','BB','TB','comment','kcal_total','carb_total','prot_total','fat_total','breakfast','lunch','dinner','snack','drink'];

      const rawHeader = splitCSV(lines[0]).map(s=>s.replace(/^"|"$/g,''));
      const headerMap = rawHeader.map(h => MAP[norm(h)] || h);

      const rows = lines.slice(1).map(line=>{
        const cols = splitCSV(line).map(c=>c.replace(/^"|"$/g,''));
        const rec = Object.fromEntries(EXPECT.map(k=>[k,'']));
        headerMap.forEach((key,i)=>{ if(EXPECT.includes(key)) rec[key] = cols[i] ?? ''; });
        return rec;
      });
      return {header:EXPECT, rows};
    }

    // ===== 集計・算出ユーティリティ =====
    const toNum = v => (v===''||v==null) ? 0 : +v;
    function calcAgg(rows){
      const sum = k => rows.reduce((a,r)=>a+toNum(r[k]),0);
      const AB=sum('AB'), H=sum('H'), HR=sum('HR'), RBI=sum('RBI'), R=sum('R'), BB=sum('BB'), TB=sum('TB');
      const OBP = (AB+BB)? ((H+BB)/(AB+BB)) : 0;
      const SLG = AB? (TB/AB) : 0;
      const OPS = OBP+SLG;
      return {AB,H,HR,RBI,R,BB,TB, AVG: AB? (H/AB):0, OBP, SLG, OPS};
    }
    function fmt3(x){ return (x||0).toFixed(3); }

    // ===== ランキング（あなた＋NLスター想定） =====
    // シーズン進捗p（あなたのデータ開始日〜今日の相対：最大1.0）
    function seasonProgress(rows){
      if(!rows.length) return 0;
      const dates = rows.map(r=>r.date).filter(Boolean).sort();
      const start = new Date(dates[0]+"T00:00:00");
      const today = new Date(new Date().toLocaleString('en-US',{timeZone:CONFIG.TIMEZONE}));
      const span = 180*24*3600*1000; // 便宜上180日をシーズン長とする
      return Math.max(0, Math.min(1, (today - start)/span));
    }
    function starProjection(p){
      // NL主要バッター（便宜上のフル到達点）
      const stars = [
        {name:"Bryce Harper", team:"PHI", HR:44, RBI:120, AVG:0.300},
        {name:"Matt Olson",   team:"ATL", HR:46, RBI:125, AVG:0.270},
        {name:"Pete Alonso",  team:"NYM", HR:45, RBI:115, AVG:0.255},
        {name:"Fernando Tatis Jr.", team:"SD", HR:38, RBI:105, AVG:0.285},
        {name:"Luis Arraez",  team:"SD", HR:10, RBI:65,  AVG:0.330}
      ];
      return stars.map(s=>({
        name: s.name, team: s.team,
        HR: Math.round(s.HR*p),
        RBI: Math.round(s.RBI*p),
        AVG: s.AVG // 打率はほぼ収束値とみなす
      }));
    }
    function buildRanking(youAgg, stars){
      const you = {name:"あなた", team:"", HR:youAgg.HR, RBI:youAgg.RBI, AVG:youAgg.AVG};
      const pool = [you, ...stars];

      const rankAvg = [...pool].sort((a,b)=>b.AVG-a.AVG).map((p,i)=>({rank:i+1, name:p.name, team:p.team, val:fmt3(p.AVG)}));
      const rankHR  = [...pool].sort((a,b)=>b.HR-a.HR).map((p,i)=>({rank:i+1, name:p.name, team:p.team, val:p.HR}));
      const rankRBI = [...pool].sort((a,b)=>b.RBI-a.RBI).map((p,i)=>({rank:i+1, name:p.name, team:p.team, val:p.RBI}));
      return {rankAvg, rankHR, rankRBI};
    }
    function renderRanking({rankAvg,rankHR,rankRBI}){
      const paint = (list, el) => {
        el.innerHTML = '';
        list.slice(0,10).forEach(row=>{
          const li = document.createElement('li');
          const isYou = row.name === "あなた";
          li.innerHTML = `<span class="inline-flex items-center gap-2">
            <span class="w-6 text-right font-semibold">${row.rank}</span>
            <span class="${isYou?'font-semibold text-blue-600':''}">${row.name}</span>
            <span class="text-slate-400">${row.team||''}</span>
          </span>
          <span class="float-right ${isYou?'font-semibold text-blue-600':''}">${row.val}</span>`;
          el.appendChild(li);
        });
      };
      paint(rankAvg, document.getElementById('rank-avg'));
      paint(rankHR , document.getElementById('rank-hr'));
      paint(rankRBI, document.getElementById('rank-rbi'));
    }

    // ===== NL West 順位（決定論シミュ） =====
    const NLW = ["LAD","SF","SD","ARI","COL"]; // NL West
    const PCT = { LAD:0.610, SF:0.520, SD:0.530, ARI:0.515, COL:0.400 }; // 便宜上の実力値
    const hashStr=(s)=>{ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619)>>>0 } return h; };
    function decideWin(home, away, dateISO){
      const pHome=(PCT[home]??.5)+.015, pAway=(PCT[away]??.5)-.015;
      const u=(hashStr(`${dateISO}:${home}-${away}`)%10000)/10000;
      const homeWins = u < (pHome/(pHome+pAway));
      const base=(hashStr(`${dateISO}:${away}-${home}`)%7);
      const homeR=3+Math.floor(base/2)+(homeWins?1:0), awayR=3+(base%2)+(homeWins?0:1);
      return {homeWins,homeR,awayR};
    }
    function rangeDates(startISO, endISO){
      const out=[]; const d=new Date(startISO+"T00:00:00"); const end=new Date(endISO+"T00:00:00");
      for(; d<=end; d.setDate(d.getDate()+1)){ out.push(d.toISOString().slice(0,10)); }
      return out;
    }
    function simNLW(startISO, endISO, enabled=true){
      const tbl = Object.fromEntries(NLW.map(t=>[t,{W:0,L:0}]));
      if(!enabled || !startISO || !endISO) return tbl;
      const days = rangeDates(startISO, endISO);
      for(const date of days){
        const restIdx = hashStr(date) % NLW.length;
        const restTeam = NLW[restIdx];
        const others = NLW.filter(t=>t!==restTeam);
        const pairs = [ {home:others[0], away:others[1]}, {home:others[2], away:others[3]} ];
        const orderHash = hashStr(date+"-ord")%2; if(orderHash===1) pairs.reverse();
        for(const m of pairs){
          if(!NLW.includes(m.home) || !NLW.includes(m.away)) continue;
          const res = decideWin(m.home, m.away, date);
          const win = res.homeWins ? m.home : m.away;
          const lose = res.homeWins ? m.away : m.home;
          tbl[win].W++; tbl[lose].L++;
        }
      }
      return tbl;
    }
    function renderNLW(table){
      const arr = Object.entries(table).map(([team,wl])=>({team, ...wl, pct:(wl.W+wl.L? wl.W/(wl.W+wl.L):0)}))
                                      .sort((a,b)=>b.pct-a.pct || (b.W-a.W));
      const tb = document.querySelector('#nlw-table tbody');
      tb.innerHTML = '';
      arr.forEach((t,i)=>{
        const gb = i===0 ? 0 : ((arr[0].W - t.W) + (t.L - arr[0].L))/2;
        const tr = document.createElement('tr');
        [i+1, t.team, t.W, t.L, t.pct.toFixed(3), gb.toFixed(1)].forEach((c,idx)=>{
          const td=document.createElement('td');
          td.className="px-3 py-2 border-b border-slate-200 "+(idx<2?"text-left":"text-center");
          td.textContent=c;
          tr.appendChild(td);
        });
        tb.appendChild(tr);
      });
    }

    // ===== ログ（食事・運動） =====
    function extractExercise(comment){
      const c=(comment||'').toString();
      const h = /([0-9]+)\s*時間/.exec(c);
      const m = /([0-9]+)\s*分/.exec(c);
      const ssets = /([0-9]+)\s*秒\s*[×x*]\s*([0-9]+)/i.exec(c);
      const km = /([0-9]+(?:\.[0-9]+)?)\s*km/i.exec(c);
      const parts=[];
      if(h) parts.push(`${h[1]}時間`);
      if(m) parts.push(`${m[1]}分`);
      if(ssets) parts.push(`${ssets[1]}秒×${ssets[2]}セット`);
      if(km) parts.push(`${km[1]}km`);
      if(/(バイク|エアロバイク|サイクリング)/.test(c) && parts.length===0) parts.push("バイク");
      if(/(ラン|ジョグ|ランニング)/.test(c) && parts.length===0) parts.push("ラン");
      return parts.join(" / ");
    }
    function renderLogs(rows){
      const tb = document.querySelector('#log-table tbody');
      tb.innerHTML='';
      const byDate = [...rows].sort((a,b)=>a.date.localeCompare(b.date));
      for(const r of byDate){
        const td = (text)=>{ const el=document.createElement('td'); el.className="px-3 py-2 border-b border-slate-200"; el.textContent=text??''; return el; };
        const tr = document.createElement('tr');
        const bat = `${r.AB||0}-${r.H||0} ${r.HR||0} ${r.RBI||0} ${r.R||0} ${r.BB||0}`;
        const nut = `${r.kcal_total||0}/${r.carb_total||0}/${r.prot_total||0}/${r.fat_total||0}`;
        tr.appendChild(td(r.date));
        tr.appendChild(td(r.opponent||''));
        tr.appendChild(td(bat));
        tr.appendChild(td(nut));
        tr.appendChild(td(r.breakfast||''));
        tr.appendChild(td(r.lunch||''));
        tr.appendChild(td(r.dinner||''));
        tr.appendChild(td(r.snack||''));
        tr.appendChild(td(r.drink||''));
        tr.appendChild(td(extractExercise(r.comment)));
        tr.appendChild(td(r.comment||''));
        tb.appendChild(tr);
      }
    }

    // ===== 入口 =====
    async function main(){
      $('#sheet-pill').textContent = `${CONFIG.SHEET_ID}/${CONFIG.SHEET_NAME}`;
      try{
        const csv = await fetchCSV();
        const {rows} = parseCSV(csv);

        // 通算
        const agg = calcAgg(rows);
        $('#agg-ab').textContent  = agg.AB;
        $('#agg-h').textContent   = agg.H;
        $('#agg-avg').textContent = fmt3(agg.AVG);
        $('#agg-hr').textContent  = agg.HR;
        $('#agg-rbi').textContent = agg.RBI;
        $('#agg-r').textContent   = agg.R;
        $('#agg-bb').textContent  = agg.BB;
        $('#agg-slg').textContent = fmt3(agg.SLG);
        $('#agg-ops').textContent = fmt3(agg.OPS);

        // ランキング（NLスター）
        const p = seasonProgress(rows);
        const stars = starProjection(p);
        const ranks = buildRanking(agg, stars);
        renderRanking(ranks);

        // NL West（データ期間に合わせる）
        const dates = rows.map(r=>r.date).filter(Boolean).sort();
        const startISO = dates[0] || new Date().toISOString().slice(0,10);
        const endISO   = new Date(new Date().toLocaleString('en-US',{timeZone:CONFIG.TIMEZONE})).toISOString().slice(0,10);
        const simOn = document.getElementById('nlw-sim-toggle').checked;
        renderNLW( simNLW(startISO, endISO, simOn) );

        // ログ
        renderLogs(rows);

        $('#status-pill').textContent = `OK（rows:${rows.length}）`;
      }catch(err){
        console.error(err);
        $('#status-pill').textContent = `エラー：${err.message}`;
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      main();
      document.getElementById('nlw-sim-toggle').addEventListener('change', main);
    });
  </script>
</body>
</html>
