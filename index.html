<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MLB Diet Dashboard – Dodgers Season</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ちょい足しのユーティリティ */
    .card { @apply bg-white/80 backdrop-blur shadow-md rounded-2xl p-5 border border-slate-200; }
    .kpi { @apply text-2xl font-semibold; }
    .mono { font-variant-numeric: tabular-nums; }
    .pill { @apply inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm border; }
    .grid-autofit { display:grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap:1rem }
    .muted { @apply text-slate-500; }
    .badge-sim { @apply text-xs px-2 py-0.5 rounded-full border border-slate-300 text-slate-500; }
    .table th { @apply bg-slate-50 text-slate-700 font-semibold; }
    .table td, .table th { @apply px-3 py-2 border-b border-slate-200; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 text-slate-800">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold">MLB Diet Dashboard <span class="text-slate-400 text-base">(Dodgers)</span></h1>
        <p class="muted">食事・運動を日々の打撃成績風に採点しつつ、2024年スケジュール／NL西順位／タイトル争いを並行トラッキング。</p>
      </div>
      <div class="flex items-center gap-2">
        <span class="pill">SHEET: <span id="sheet-pill" class="font-mono">(未設定)</span></span>
        <span id="status-pill" class="pill">読み込み中...</span>
      </div>
    </header>

    <!-- NEXT GAME / SERIES -->
    <section class="grid-autofit mb-6">
      <div class="card">
        <h2 class="font-bold mb-3">NEXT GAME</h2>
        <div id="next-game" class="text-lg">—</div>
        <div id="series-note" class="muted text-sm mt-1">—</div>
      </div>
      <div class="card">
        <h2 class="font-bold mb-3">今日の自己スコア（打撃成績風）</h2>
        <div id="today-kpis" class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          <div><div class="muted text-sm">AB</div><div class="kpi mono" id="kpi-ab">—</div></div>
          <div><div class="muted text-sm">H</div><div class="kpi mono" id="kpi-h">—</div></div>
          <div><div class="muted text-sm">HR</div><div class="kpi mono" id="kpi-hr">—</div></div>
          <div><div class="muted text-sm">OPS 風スコア</div><div class="kpi mono" id="kpi-ops">—</div></div>
        </div>
        <div class="muted text-sm mt-2" id="kpi-comment">—</div>
      </div>
      <div class="card">
        <h2 class="font-bold mb-3">栄養サマリ（本日）</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          <div><div class="muted text-sm">kcal</div><div class="kpi mono" id="kcal">—</div></div>
          <div><div class="muted text-sm">炭水化物 (g)</div><div class="kpi mono" id="carb">—</div></div>
          <div><div class="muted text-sm">たんぱく (g)</div><div class="kpi mono" id="prot">—</div></div>
          <div><div class="muted text-sm">脂質 (g)</div><div class="kpi mono" id="fat">—</div></div>
        </div>
        <div class="muted text-xs mt-2" id="meal-note">—</div>
      </div>
    </section>

    <!-- STANDINGS / TITLE RACE -->
    <section class="grid-autofit mb-6">
      <div class="card">
        <h2 class="font-bold mb-3">NL West Standings <span class="badge-sim" title="LAD以外は決定論シミュ">Sim.</span></h2>
        <div class="overflow-x-auto">
          <table class="table w-full text-sm" id="standings-table">
            <thead><tr><th>Team</th><th>W</th><th>L</th><th>PCT</th><th>RS</th><th>RA</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <h2 class="font-bold mb-3">タイトル争い（進行型）</h2>
        <div class="overflow-x-auto">
          <table class="table w-full text-sm" id="title-table">
            <thead><tr><th>Player</th><th>Title</th><th>Today</th><th>Season Pace</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="muted text-xs mt-2">※ アーロン・ジャッジのHRは 55〜58本収束を想定。日数進捗に応じて平滑化。</p>
      </div>
    </section>

    <!-- GAME LOG -->
    <section class="card mb-6">
      <h2 class="font-bold mb-3">試合ログ（games シート参照）</h2>
      <div class="overflow-x-auto">
        <table class="table w-full text-sm" id="games-table">
          <thead>
            <tr>
              <th>date</th><th>opponent</th><th>LAD</th><th>OPP</th><th>W/L</th>
              <th>AB</th><th>H</th><th>HR</th><th>RBI</th><th>R</th><th>BB</th><th>TB</th>
              <th>kcal</th><th>carb</th><th>prot</th><th>fat</th>
              <th>comment</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- スケジュール編集（読み取り専用UIサンプル） -->
    <section class="card mb-10">
      <h2 class="font-bold mb-3">スケジュール設定</h2>
      <div class="text-sm space-y-1">
        <div>参照: <code class="bg-slate-100 px-1 rounded">schedule-2024.json</code>（2024年実スケジュール準拠・<b>シリーズID</b>で連戦管理）</div>
        <div>配置: 本ファイルと同階層 / または下の <code>&lt;script id="schedule-embed" type="application/json"&gt;</code> を編集</div>
      </div>
      <div class="mt-3">
        <button id="btn-reload" class="px-3 py-1.5 rounded-lg border">再読み込み</button>
      </div>
    </section>

    <footer class="text-center text-xs text-slate-500 pb-10">© Dashboard template. Built for puriowing / gaie.</footer>
  </div>

  <!-- ====================
       設定ブロック（編集してください）
       ==================== -->
  <script>
    // ▼▼▼ 必要に応じて書き換え ▼▼▼
    const CONFIG = {
      SHEET_ID: "<YOUR_GOOGLE_SHEET_ID>", // 例: 1AbCdEfG... （ウェブに公開：CSV可 or API方式に差し替え）
      SHEET_NAME: "games",
      TEAM: "LAD",
      TIMEZONE: "Asia/Tokyo", // 日付集計に使用（ユーザーは東京）
      SCHEDULE_JSON_URL: "./schedule-2024.json", // 外部ファイル。無い場合は下の埋め込みJSONを利用
    };
    // ▲▲▲ 必要に応じて書き換え ▲▲▲
  </script>

  <!-- スケジュール埋め込み（暫定：開幕〜2カード分のサンプル）
       完全再現したい場合は schedule-2024.json を全量で用意 or このJSONを拡張 -->
  <script id="schedule-embed" type="application/json">[
    { "date": "2024-03-28", "opp": "STL", "home": true,  "seriesId": "STL-20240328-31" },
    { "date": "2024-03-29", "opp": "STL", "home": true,  "seriesId": "STL-20240328-31" },
    { "date": "2024-03-30", "opp": "STL", "home": true,  "seriesId": "STL-20240328-31" },
    { "date": "2024-03-31", "opp": "STL", "home": true,  "seriesId": "STL-20240328-31" },

    { "date": "2024-04-01", "opp": "SFG", "home": true,  "seriesId": "SFG-20240401-03" },
    { "date": "2024-04-02", "opp": "SFG", "home": true,  "seriesId": "SFG-20240401-03" },
    { "date": "2024-04-03", "opp": "SFG", "home": true,  "seriesId": "SFG-20240401-03" }
  ]</script>

  <!-- ====================
       アプリ本体
       ==================== -->
  <script>
  // ------------------ ユーティリティ ------------------
  const NLW = ["LAD","SFG","SDP","ARI","COL"];
  const AL_POOL = ["SEA","TEX","HOU","LAA","OAK"]; // 例: AL西

  // 過去3年勝率（例値：必要に応じて更新）
  const PCT_3Y = { LAD:0.615, SFG:0.515, SDP:0.520, ARI:0.505, COL:0.420, SEA:0.540, TEX:0.540, HOU:0.570, LAA:0.430, OAK:0.350 };

  function by(selector){ return document.querySelector(selector); }
  function fmtPCT(w,l){ const g=w+l; return g? (w/g).toFixed(3).padStart(5,'0') : "—" }
  function toLocalISO(d){ const z = new Date(d.toLocaleString('en-US',{timeZone:CONFIG.TIMEZONE})); return z.toISOString().slice(0,10); }

  function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619)>>>0 } return h; }

  function decideWin(homeTeam, awayTeam, dateISO){
    const pHome = (PCT_3Y[homeTeam]??0.5)+0.015;
    const pAway = (PCT_3Y[awayTeam]??0.5)-0.015;
    const pHomeWin = pHome/(pHome+pAway);
    const u = (hashStr(`${dateISO}:${homeTeam}-${awayTeam}`)%10000)/10000; // 0..1
    const homeWins = u < pHomeWin;
    const base = (hashStr(`${dateISO}:${awayTeam}-${homeTeam}`)%7); // 0..6
    const homeR = 3 + Math.floor(base/2) + (homeWins?1:0);
    const awayR = 3 + (base%2) + (homeWins?0:1);
    return { homeWins, homeR, awayR };
  }

  function applyResultToStandings(stand, home, away, res){
    const tHome = stand[home] ?? (stand[home]={W:0,L:0,RS:0,RA:0});
    const tAway = stand[away] ?? (stand[away]={W:0,L:0,RS:0,RA:0});
    tHome.RS+=res.homeR; tHome.RA+=res.awayR; tAway.RS+=res.awayR; tAway.RA+=res.homeR;
    if(res.homeWins){ tHome.W++; tAway.L++; } else { tAway.W++; tHome.L++; }
  }

  function pairNonDodgers(dateISO, dodgersOpp){
    const rest = NLW.filter(t=>t!=="LAD" && t!==dodgersOpp);
    const [t1,t2,t3] = rest; // 3チーム
    const alIdx = hashStr(dateISO)%AL_POOL.length;
    const alOpp = AL_POOL[alIdx];
    return [ {home:t1,away:t2}, {home:t3,away:alOpp} ];
  }

  // 打撃成績風スコア（簡易OPS風）
  function battingScore({AB,H,HR,BB,TB}){
    const ab = +AB||0, h=+H||0, hr=+HR||0, bb=+BB||0, tb=+TB||0;
    const obp = (h+bb)/Math.max(1,(ab+bb));
    const slg = tb/Math.max(1,ab);
    const ops = obp + slg; // 0〜2弱
    return {ops: +ops.toFixed(3)};
  }

  // ------------------ スケジュール ------------------
  async function loadSchedule(){
    try{
      if(CONFIG.SCHEDULE_JSON_URL){
        const r = await fetch(CONFIG.SCHEDULE_JSON_URL, {cache:'no-store'});
        if(r.ok){ const j = await r.json(); return j.sort((a,b)=>a.date.localeCompare(b.date)); }
      }
    }catch(e){ console.warn('外部スケジュール取得失敗。埋め込みJSONにフォールバック', e); }
    try{
      const text = by('#schedule-embed')?.textContent;
      if(text){ const j=JSON.parse(text); return j.sort((a,b)=>a.date.localeCompare(b.date)); }
    }catch(e){ console.error('埋め込みJSONのパースに失敗', e); }
    return [];
  }

  function findNextGame(schedule, todayISO){
    return schedule.find(g=>g.date>=todayISO);
  }

  function seriesSpan(schedule, seriesId){
    const s = schedule.filter(g=>g.seriesId===seriesId);
    if(!s.length) return null;
    return { start:s[0].date, end:s[s.length-1].date, opp:s[0].opp };
  }

  // ------------------ Google シート読込 ------------------
  async function loadGamesFromSheet(){
    if(!CONFIG.SHEET_ID){ throw new Error('SHEET_ID 未設定'); }
    const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(CONFIG.SHEET_NAME)}`;
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const csv = await res.text();
    return parseCSV(csv);
  }

  function parseCSV(text){
    const lines = text.split(/\r?\n/).filter(Boolean);
    const header = lines[0].split(',').map(s=>s.replace(/^"|"$/g,''));
    const rows = lines.slice(1).map(line=>{
      const cols = splitCSV(line);
      const rec = {}; header.forEach((h,i)=> rec[h]=cols[i]!==undefined?cols[i].replace(/^"|"$/g,''):'' );
      return rec;
    });
    return { header, rows };
  }
  function splitCSV(line){
    const out=[]; let cur=''; let quoted=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){
        if(quoted && line[i+1]==='"'){ cur+='"'; i++; }
        else { quoted=!quoted; }
      }else if(ch===',' && !quoted){ out.push(cur); cur=''; }
      else { cur+=ch; }
    }
    out.push(cur); return out;
  }

  // ------------------ タイトル争い ------------------
  const TITLE_PLAYERS = [
    { name:'Aaron Judge',   team:'NYY', title:'HR', target:[55,58] },
    { name:'Shohei Ohtani', team:'LAD', title:'OPS', target:[0.970,1.050] },
    { name:'Mookie Betts',  team:'LAD', title:'R',   target:[120,135] }
  ];

  function seasonProgress(dateISO){
    // 2024シーズン基準で 3/28〜9/29 あたりを正規化（ざっくり）
    const start = new Date('2024-03-28T00:00:00Z');
    const end   = new Date('2024-09-30T00:00:00Z');
    const d = new Date(dateISO+'T00:00:00Z');
    const p = Math.max(0, Math.min(1, (d-start)/(end-start)));
    return p;
  }

  function titleRows(todayISO){
    const p = seasonProgress(todayISO);
    return TITLE_PLAYERS.map(pl=>{
      const [a,b] = pl.target;
      let today; let pace;
      if(pl.title==='HR'){
        const hr = a + (b-a)*p; today = `${hr.toFixed(1)} HR`;
        pace = `${Math.round(hr)} HR pace`;
      }else if(pl.title==='OPS'){
        const v = a + (b-a)*p; today = v.toFixed(3); pace = `${v.toFixed(3)} pace`;
      }else if(pl.title==='R'){
        const v = a + (b-a)*p; today = `${v.toFixed(0)} R`; pace = `${Math.round(v)} R pace`;
      }
      return { player: pl.name, team: pl.team, title: pl.title, today, pace };
    });
  }

  // ------------------ レンダリング ------------------
  function renderNextGame(next, schedule){
    const el = by('#next-game');
    const ns = next ? `${next.date} vs ${next.opp} ${next.home?'(Home)':'(Away)'}` : '—';
    el.textContent = ns;
    const s = next ? seriesSpan(schedule, next.seriesId) : null;
    by('#series-note').textContent = s? `Series: ${s.opp} / ${s.start}–${s.end}` : '—';
  }

  function renderGamesTable(rows){
    const tb = by('#games-table tbody');
    tb.innerHTML = '';
    for(const r of rows){
      const tr = document.createElement('tr');
      const cells = [
        r.date, r.opponent, r.dodgers_runs, r.opp_runs, r.result,
        r.AB, r.H, r.HR, r.RBI, r.R, r.BB, r.TB,
        r.kcal_total, r.carb_total, r.prot_total, r.fat_total, r.comment
      ];
      for(const c of cells){ const td=document.createElement('td'); td.textContent=c||''; tr.appendChild(td); }
      tb.appendChild(tr);
    }
  }

  function renderToday(rows, todayISO){
    const today = rows.find(r=>r.date===todayISO);
    if(!today){ by('#kpi-ab').textContent='—'; by('#kpi-comment').textContent='本日のレコード未入力'; return; }
    const {ops} = battingScore(today);
    by('#kpi-ab').textContent = today.AB||'0';
    by('#kpi-h').textContent  = today.H||'0';
    by('#kpi-hr').textContent = today.HR||'0';
    by('#kpi-ops').textContent= ops.toFixed(3);

    by('#kcal').textContent = today.kcal_total||'0';
    by('#carb').textContent = today.carb_total||'0';
    by('#prot').textContent = today.prot_total||'0';
    by('#fat').textContent  = today.fat_total||'0';

    by('#meal-note').textContent = `朝: ${today.breakfast||'-'} / 昼: ${today.lunch||'-'} / 夜: ${today.dinner||'-'} / 間: ${today.snack||'-'} / 飲: ${today.drink||'-'}`;
    by('#kpi-comment').textContent = today.comment||'';
  }

  function renderStandings(rows, schedule, uptoISO){
    // LAD 実績＋他カード決定論シミュ
    const stand = {};
    // 1) LAD 実績
    for(const r of rows){
      if(r.date>uptoISO) continue;
      const ladRuns = +r.dodgers_runs||0, oppRuns=+r.opp_runs||0;
      const opp = r.opponent||'?';
      const home = true; // シートに home/away が無いので集計は中立
      const res = { homeWins: ladRuns>=oppRuns, homeR: ladRuns, awayR: oppRuns };
      applyResultToStandings(stand, 'LAD', opp, res);
    }

    // 2) 同日の他カード
    const dates = Array.from(new Set(schedule.map(g=>g.date))).filter(d=>d<=uptoISO);
    for(const d of dates){
      const dg = schedule.find(g=>g.date===d);
      if(!dg) continue;
      // LADカード
      const ladOpp = dg.opp;
      // 他カード割当
      const pairs = pairNonDodgers(d, ladOpp);
      for(const m of pairs){
        const res = decideWin(m.home, m.away, d);
        applyResultToStandings(stand, m.home, m.away, res);
      }
    }

    // 表示
    const order = Object.entries(stand).map(([k,v])=>({team:k,...v})).sort((a,b)=> (b.W/(b.W+b.L||1)) - (a.W/(a.W+a.L||1)) );
    const tb = by('#standings-table tbody'); tb.innerHTML='';
    for(const t of order){
      const tr=document.createElement('tr');
      const pct=fmtPCT(t.W,t.L);
      const cells=[t.team,t.W,t.L,pct,t.RS,t.RA];
      for(const c of cells){ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); }
      tb.appendChild(tr);
    }
  }

  function renderTitleRace(todayISO){
    const rows = titleRows(todayISO);
    const tb = by('#title-table tbody'); tb.innerHTML='';
    for(const r of rows){
      const tr=document.createElement('tr');
      [ `${r.player} (${r.team})`, r.title, r.today, r.pace ].forEach(c=>{
        const td=document.createElement('td'); td.textContent=c; tr.appendChild(td);
      });
      tb.appendChild(tr);
    }
  }

  // ------------------ 起動 ------------------
  async function main(){
    by('#sheet-pill').textContent = `${CONFIG.SHEET_ID}/${CONFIG.SHEET_NAME}`;

    try{
      const [schedule, sheet] = await Promise.all([
        loadSchedule(),
        loadGamesFromSheet()
      ]);

      const todayISO = toLocalISO(new Date());
      const next = findNextGame(schedule, todayISO);
      renderNextGame(next, schedule);

      renderGamesTable(sheet.rows);
      renderToday(sheet.rows, todayISO);

      const upto = todayISO; // 当日までで順位更新
      renderStandings(sheet.rows, schedule, upto);
      renderTitleRace(todayISO);

      by('#status-pill').textContent = 'OK';
      by('#status-pill').className = 'pill border-green-300 text-green-700';
    }catch(e){
      console.error(e);
      by('#status-pill').textContent = 'エラー';
      by('#status-pill').className = 'pill border-red-300 text-red-700';
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    main();
    by('#btn-reload').addEventListener('click', main);
  });
  </script>
</body>
</html>
