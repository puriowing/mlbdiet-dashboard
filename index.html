<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ドジャース減量シーズン・ダッシュボード（完全統合＋食事明細＋NEXT GAME自動＋タイトル進行型FIX）</title>
<style>
  :root{
    --ink:#111827; --muted:#6b7280; --border:#e5e7eb; --bg:#f9fafb; --card:#ffffff; --brand:#1f2937;
    --ok:#065f46; --warn:#92400e; --bad:#991b1b;
  }
  *{box-sizing:border-box}
  body{margin:0; color:var(--ink); background:var(--bg);
    font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
      "Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic", Meiryo, sans-serif;}
  .wrap{max-width:1100px; margin:20px auto; padding:0 14px;}
  header{margin:6px 0 16px;}
  h1{font-size:22px; margin:0 0 6px;}
  h2{font-size:16px; margin:0 0 8px}
  .muted{color:var(--muted); font-size:12px}
  .grid{display:grid; grid-template-columns: repeat(12,1fr); gap:14px;}
  .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; box-shadow:0 1px 2px rgba(0,0,0,.04);}
  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{padding:8px 10px; border-bottom:1px solid var(--border); text-align:left; white-space:nowrap}
  th{background:#f3f4f6; font-weight:600}
  .kvs{display:flex; gap:10px; flex-wrap:wrap}
  .kv{background:#f3f4f6; border:1px solid var(--border); border-radius:10px; padding:6px 10px; font-size:13px}
  .scroll{overflow-x:auto; -webkit-overflow-scrolling:touch;}
  .pill{display:inline-block; background:#eef2ff; color:#3730a3; border-radius:999px; padding:2px 8px; font-size:12px}
  .span-6{grid-column: span 6} .span-4{grid-column: span 4} .span-8{grid-column: span 8} .span-12{grid-column: span 12}
  @media (max-width: 768px){
    .grid{grid-template-columns: repeat(6,1fr); gap:10px;}
    .span-6,.span-4,.span-8,.span-12{grid-column: 1 / -1;}
    th,td{padding:8px 6px; font-size:13px}
    h1{font-size:20px} h2{font-size:15px}
  }
  .small{font-size:12px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  input, textarea{padding:8px; border:1px solid #d1d5db; border-radius:8px; font-family:inherit; font-size:14px;}
  button{padding:8px 12px; border-radius:10px; border:1px solid var(--brand); background:var(--brand); color:#fff; cursor:pointer}
  button.ghost{background:#fff; color:var(--brand); border-color:#d1d5db}
  details summary{cursor:pointer; user-select:none}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ドジャース減量シーズン・ダッシュボード（完全統合＋食事明細＋NEXT GAME自動＋タイトル進行型FIX版）</h1>
      <div class="muted">Googleシート <code>games</code> を読み込み：打撃・栄養・試合結果／<b>NL西スタンディング（実力重みシミュレーション）</b>／<b>タイトル争い（進行型）</b>／<b>ターゲット評価</b>／<b>NEXT GAME（自動）</b>／<b>食事明細</b> を表示。</div>
    </header>

    <section class="grid">
      <div class="card span-6">
        <h2>通算打撃成績</h2>
        <div class="kvs">
          <div class="kv">試合 <strong id="G">-</strong></div>
          <div class="kv">AB <strong id="AB">-</strong></div>
          <div class="kv">H <strong id="H">-</strong></div>
          <div class="kv">HR <strong id="HR">-</strong></div>
          <div class="kv">RBI <strong id="RBI">-</strong></div>
          <div class="kv">R <strong id="R">-</strong></div>
          <div class="kv">BB <strong id="BB">-</strong></div>
          <div class="kv">TB <strong id="TB">-</strong></div>
        </div>
        <div class="kvs" style="margin-top:8px">
          <div class="kv">AVG <strong id="AVG">.000</strong></div>
          <div class="kv">OBP <strong id="OBP">.000</strong></div>
          <div class="kv">SLG <strong id="SLG">.000</strong></div>
          <div class="kv">OPS <strong id="OPS">.000</strong></div>
        </div>
      </div>

      <div class="card span-6">
        <h2>栄養（直近日の合計）<span id="judgeBadge" class="pill" style="margin-left:6px;display:none"></span></h2>
        <div class="kvs">
          <div class="kv">kcal <strong id="KCAL">-</strong></div>
          <div class="kv">糖質 <strong id="CARB">-</strong></div>
          <div class="kv">P <strong id="PROT">-</strong></div>
          <div class="kv">F <strong id="FAT">-</strong></div>
        </div>
        <div id="judge" class="small" style="margin-top:8px;color:#6b7280">ターゲット設定に基づき、最新日の評価を表示します。</div>
      </div>

      <div class="card span-12">
        <h2>試合ログ（食事明細つき）</h2>
        <div class="scroll">
          <table id="gameLog">
            <thead>
              <tr>
                <th>日付</th><th>対戦相手</th><th>スコア</th><th>結果</th>
                <th>成績（AB-H HR RBI R BB）</th>
                <th>栄養(kcal/C/P/F)</th>
                <th>朝食</th><th>昼食</th><th>夕食</th><th>間食</th><th>飲酒</th>
                <th>コメント</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card span-4">
        <h2>ナ・リーグ西地区（Standings：実力重み付き）</h2>
        <div class="scroll">
          <table id="nlw">
            <thead><tr><th>順位</th><th>チーム</th><th>勝</th><th>敗</th><th>勝率</th><th>GB</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small muted">非LAD試合は、各球団の過去3年勝率（重み）で確率決定（決定論的乱数）。</div>
        <div class="small" style="margin-top:6px"><label><input id="simToggle" type="checkbox" checked> シミュレーションを有効にする</label></div>
      </div>

      <div class="card span-4">
        <h2>MLB タイトル争い（スター比較・<span class="pill">進行型</span>）</h2>
        <div class="scroll">
          <table>
            <thead><tr><th>タイトル</th><th>順位</th><th>トップ選手</th><th>トップ値</th><th>あなた</th></tr></thead>
            <tbody>
              <tr><td>首位打者</td><td id="rankAVGPos">-</td><td id="rankAVGName">-</td><td id="rankAVGTop">-</td><td id="rankAVGYou">-</td></tr>
              <tr><td>本塁打王</td><td id="rankHRPos">-</td><td id="rankHRName">-</td><td id="rankHRTop">-</td><td id="rankHRYou">-</td></tr>
              <tr><td>打点王</td><td id="rankRBIPos">-</td><td id="rankRBIName">-</td><td id="rankRBITop">-</td><td id="rankRBIYou">-</td></tr>
              <tr><td>得点王</td><td id="rankRPos">-</td><td id="rankRName">-</td><td id="rankRTop">-</td><td id="rankRYou">-</td></tr>
            </tbody>
          </table>
        </div>
        <div class="small muted">※ スターの成績は2025年想定値ベースで「試合数に応じて」進行。ジャッジHRはシーズン55〜58本に収束するよう調整。</div>
      </div>

      <div class="card span-4">
        <h2>ターゲット設定（1日）</h2>
        <div class="kvs">
          <div class="kv">kcal <input id="tCalLow" type="number" value="1900" style="width:90px">〜<input id="tCalHigh" type="number" value="2100" style="width:90px"></div>
          <div class="kv">糖質g <input id="tCarbLow" type="number" value="150" style="width:80px">〜<input id="tCarbHigh" type="number" value="200" style="width:80px"></div>
          <div class="kv">P目標g <input id="tProt" type="number" value="120" style="width:90px"></div>
          <div class="kv">脂質g <input id="tFatLow" type="number" value="50" style="width:80px">〜<input id="tFatHigh" type="number" value="60" style="width:80px"></div>
        </div>
        <div style="margin-top:8px">
          <button id="saveTargets">ターゲット保存</button>
          <button id="resetTargets" class="ghost" style="margin-left:8px">初期値</button>
        </div>
        <div class="small muted" style="margin-top:6px">設定はブラウザの localStorage に保存。</div>
      </div>

      <div class="card span-6">
        <h2>最新試合 & NEXT GAME（自動）</h2>
        <div class="kvs">
          <div class="kv">最新試合 <strong id="latestGame">-</strong></div>
          <div class="kv">NEXT GAME <strong id="nextAuto">-</strong></div>
        </div>
        <div class="small muted" style="margin-top:6px">内蔵スケジュールは2025年の公式日程に近い並び。必要に応じて下のJSONから編集できます。</div>
      </div>

      <div class="card span-6">
        <h2>スケジュール編集（JSON）</h2>
        <details>
          <summary>開く / 閉じる</summary>
          <div class="small muted" style="margin:6px 0">このJSONの <code>series</code> に並ぶ対戦順（相手・ホーム/ビジター）を編集可。保存不要・即時反映。</div>
          <textarea id="schedJson" style="width:100%; min-height:220px;"></textarea>
          <div style="margin-top:8px">
            <button id="apply">反映</button>
            <span id="applyMsg" class="small muted" style="margin-left:8px"></span>
          </div>
        </details>
      </div>
    </section>
  </div>

<script>
// ===== 基本設定 =====
const SHEET_ID = "1b3oO6nDY1d-jmP2cFchm7ld5PvKIr34vh0KXYYKxx8I"; // ← あなたのIDをセット
const SHEET_NAME = "games";
const REFRESH_SEC = 20;

// ▼ 実力重み（過去3年の勝率イメージ：必要に応じて調整可）
const TEAM_STRENGTH = {
  "ドジャース": 0.585,
  "ジャイアンツ": 0.520,
  "パドレス": 0.500,
  "Dバックス": 0.490,
  "ロッキーズ": 0.430,
};

// ▼ 内蔵スケジュール（2025に近い並び）
let SCHEDULE = {
  start: "2025-03-30",
  series: [
    {"opp":"ジャイアンツ","ha":"H","len":3},
    {"opp":"パドレス","ha":"H","len":4},
    {"opp":"Dバックス","ha":"H","len":3},
    {"opp":"カージナルス","ha":"A","len":3},
    {"opp":"ロッキーズ","ha":"A","len":3},
    {"opp":"ナショナルズ","ha":"H","len":3},
    {"opp":"メッツ","ha":"H","len":4},
    {"opp":"カブス","ha":"A","len":3},
    {"opp":"ブレーブス","ha":"A","len":3},
    {"opp":"フィリーズ","ha":"H","len":3},
    {"opp":"ヤンキース","ha":"H","len":3},
    {"opp":"Dバックス","ha":"H","len":3},
    {"opp":"ジャイアンツ","ha":"A","len":3},
    {"opp":"パドレス","ha":"A","len":4},
    {"opp":"ロッキーズ","ha":"H","len":3},
    {"opp":"アストロズ","ha":"A","len":3},
    {"opp":"マリナーズ","ha":"A","len":2},
    {"opp":"レンジャーズ","ha":"H","len":3},
    {"opp":"レッズ","ha":"H","len":3},
    {"opp":"ブルワーズ","ha":"A","len":3},
    {"opp":"パイレーツ","ha":"A","len":3},
    {"opp":"マリナーズ","ha":"H","len":2},
    {"opp":"エンゼルス","ha":"H","len":3},
    {"opp":"ナショナルズ","ha":"A","len":3},
    {"opp":"マーリンズ","ha":"A","len":3},
    {"opp":"カージナルス","ha":"H","len":3},
    {"opp":"ロッキーズ","ha":"A","len":3},
    {"opp":"ジャイアンツ","ha":"H","len":3},
    {"opp":"パドレス","ha":"H","len":3},
    {"opp":"Dバックス","ha":"A","len":3},
    {"opp":"フィリーズ","ha":"A","len":3},
    {"opp":"ブルージェイズ","ha":"A","len":2},
    {"opp":"レイズ","ha":"A","len":2},
    {"opp":"メッツ","ha":"A","len":3},
    {"opp":"ブレーブス","ha":"H","len":3},
    {"opp":"カブス","ha":"H","len":3},
    {"opp":"レッズ","ha":"A","len":3},
    {"opp":"ブルワーズ","ha":"H","len":3},
    {"opp":"パイレーツ","ha":"H","len":3},
    {"opp":"ロッキーズ","ha":"H","len":3}
  ]
};
function expandDays(schedule){
  const out=[];
  const start=new Date(schedule.start+"T00:00:00");
  let cur=new Date(start);
  schedule.series.forEach(s=>{
    for(let i=0;i<s.len;i++){
      out.push({date:cur.toISOString().slice(0,10), opp:s.opp, ha:s.ha});
      cur.setDate(cur.getDate()+1);
    }
    cur.setDate(cur.getDate()+1); // 1日オフ
  });
  return out;
}
let EXPANDED = expandDays(SCHEDULE);

// ===== GViz fetch =====
function gvizUrl(){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;
}
async function fetchSheet(){
  const res = await fetch(gvizUrl());
  const txt = await res.text();
  const m = txt.match(/setResponse\(([\s\S]*)\)/);
  if(!m) throw new Error("GViz応答の解析に失敗。公開設定・SHEET_ID・シート名(games)を確認してください。");
  const json = JSON.parse(m[1]);
  const cols = json.table.cols.map(c=>c.label || c.id);

  // --- ここから：正規化（数値は生値v優先 / Date(...)→ISO） ---
  const rows = json.table.rows.map(r=>{
    const obj = {};
    cols.forEach((c,i)=>{
      const cell = r.c[i];
      let val = null;
      if (cell) {
        val = (cell.v !== null && cell.v !== undefined) ? cell.v : (cell.f ?? null);
      }
      if (typeof val === 'string' && /^Date\(/.test(val)) {
        val = parseGvizDate(val); // "Date(YYYY,MM,DD)"→"YYYY-MM-DD"
      }
      obj[c] = val;
    });
    // 代表カラム名を補助的に複写（あなたのシートに合わせて調整可）
    if (obj['日付'] && !obj['date']) obj['date'] = obj['日付'];
    if (obj['相手'] && !obj['opponent']) obj['opponent'] = obj['相手'];
    return obj;
  });
  return rows;
}

// ===== Util =====
function pct(w,l){ const g=w+l; return g? (Math.round((w/g)*1000)/1000).toFixed(3).padStart(5,'0') : ".000"; }
function gb(leaderW, leaderL, w, l){ const v=((leaderW-w)+(l-leaderL))/2; return v===0? "-" : v.toFixed(1); }
function normTeam(n){ if(!n) return null; const s=String(n).toLowerCase();
  if(s.includes("巨")||s.includes("ジャイ")) return "ジャイアンツ";
  if(s.includes("pad")||s.includes("パド")) return "パドレス";
  if(s.includes("d-back")||s.includes("dバッ")||s.includes("ari")||s.includes("dbacks")||s.includes("ダイア")) return "Dバックス";
  if(s.includes("rock")||s.includes("ロッ")) return "ロッキーズ";
  if(s.includes("dodg")||s.includes("ドジャ")) return "ドジャース";
  return n;
}
function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }
function seedFromString(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
function rng(seed){ let x=seed>>>0; return function(){ x^=x<<13; x^=x>>>17; x^=x<<5; return ((x>>>0)/4294967296);}}
function randn(r){ const u = r()||1e-9, v = r()||1e-9; return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); }

// --- normalization helpers（★追加） ---
function toNumber(v){
  if (v == null) return 0;
  const s = String(v).trim().replace(/[ ,，]/g, '');
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : 0;
}
// "Date(2025,9,4)" -> "2025-10-04"
function parseGvizDate(s){
  if (typeof s !== 'string') return s;
  const m = s.match(/Date\((\d+),\s*(\d+),\s*(\d+)/);
  if (!m) return s;
  const y = +m[1], mo = +m[2] + 1, d = +m[3];
  return `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
}

// ===== スター進行シミュレーション（2025ベースライン） =====
const STARS = [
  {name:"アーロン・ジャッジ",  hrRate:0.36, rbiRate:0.75, rRate:0.80, avgTarget:0.285, avgVol:0.015}, // ~58 HR
  {name:"大谷翔平",           hrRate:0.28, rbiRate:0.68, rRate:0.62, avgTarget:0.280, avgVol:0.015},
  {name:"ルイス・アラエス",   hrRate:0.02, rbiRate:0.31, rRate:0.43, avgTarget:0.320, avgVol:0.010},
  {name:"フレディ・フリーマン",hrRate:0.13, rbiRate:0.59, rRate:0.59, avgTarget:0.300, avgVol:0.012},
  {name:"ラファエル・デバース",hrRate:0.21, rbiRate:0.74, rRate:0.52, avgTarget:0.285, avgVol:0.015},
  {name:"フアン・ソト",       hrRate:0.18, rbiRate:0.56, rRate:0.68, avgTarget:0.285, avgVol:0.012},
  {name:"ロナルド・アクーニャJr.",hrRate:0.18, rbiRate:0.49, rRate:0.74, avgTarget:0.285, avgVol:0.015},
];
function simulateStars(games){
  const r = rng(seedFromString("stars|"+games));
  return STARS.map(s=>{
    const meanHR = s.hrRate*games, sdHR = Math.sqrt(Math.max(1,meanHR))*0.7;
    const meanRBI= s.rbiRate*games, sdRBI= Math.sqrt(Math.max(1,meanRBI))*0.6;
    const meanR  = s.rRate*games,   sdR  = Math.sqrt(Math.max(1,meanR))*0.6;
    let HR = Math.max(0, Math.round(meanHR + sdHR*randn(r)));
    let RBI= Math.max(0, Math.round(meanRBI + sdRBI*randn(r)));
    let R  = Math.max(0, Math.round(meanR + sdR*randn(r)));
    const vol = s.avgVol / Math.sqrt(Math.max(1,games));
    let AVG = clamp(s.avgTarget + vol*randn(r), s.avgTarget-0.05, s.avgTarget+0.05);
    AVG = Math.round(AVG*1000)/1000;
    return {name:s.name, HR, RBI, R, AVG};
  });
}

// ===== 集計（非LAD戦シミュ＋通算） =====
function compute(rows, enableSim){
  let G=0,AB=0,H=0,HR=0,RBI=0,R=0,BB=0,TB=0; let lastK=0,lastC=0,lastP=0,lastF=0;
  const standings={"ドジャース":{w:0,l:0},"ジャイアンツ":{w:0,l:0},"パドレス":{w:0,l:0},"Dバックス":{w:0,l:0},"ロッキーズ":{w:0,l:0}};
  const logRows=[]; const datesSet=new Set();

  rows.forEach(r=>{
    const date=(r.date||r.Date||r.DATE||'');
    const opp=normTeam(r.opponent||r.Opponent||r.OPP);
    const ds=toNumber(r.dodgers_runs||r.Dodgers||r.ds||0);
    const os=toNumber(r.opp_runs||r.Opp||r.os||0);
    const res=r.result || (ds>os?'W':(ds<os?'L':'T'));
    const ab=toNumber(r.AB||r.ab||0);
    const h =toNumber(r.H ||r.h ||0);
    const hr=toNumber(r.HR||r.hr||0);
    const rbi=toNumber(r.RBI||r.rbi||0);
    const rr =toNumber(r.R ||r.r ||0);
    const bb =toNumber(r.BB||r.bb||0);
    let tb   =toNumber(r.TB||r.tb||0);
    const kcal=toNumber(r.kcal_total??r.kcal??0);
    const carb=toNumber(r.carb_total??r.carb??0);
    const prot=toNumber(r.prot_total??r.prot??0);
    const fat =toNumber(r.fat_total ??r.fat ??0);
    const comment=r.comment||'';
    const breakfast=r.breakfast || r.BREAKFAST || r.Breakfast || "";
    const lunch=r.lunch || r.LUNCH || r.Lunch || "";
    const dinner=r.dinner || r.DINNER || r.Dinner || "";
    const snack=r.snack || r.SNACK || r.Snack || "";
    const drink=r.drink || r.DRINK || r.Drink || "";
    if(!tb||tb===0){tb=h+3*hr;}
    G+=1; AB+=ab; H+=h; HR+=hr; RBI+=rbi; R+=rr; BB+=bb; TB+=tb;
    lastK=kcal; lastC=carb; lastP=prot; lastF=fat;

    if(res==='W'){standings['ドジャース'].w++; if(standings[opp]) standings[opp].l++;}
    else if(res==='L'){standings['ドジャース'].l++; if(standings[opp]) standings[opp].w++;}

    logRows.push({date,opp,ds,os,res,ab,h,hr,rbi,rr,bb,kcal,carb,prot,fat,comment,breakfast,lunch,dinner,snack,drink});
    if(date) datesSet.add(String(date));
  });

  if(enableSim){
    const dates=Array.from(datesSet).sort();
    const pool=['ジャイアンツ','パドレス','Dバックス','ロッキーズ'];
    dates.forEach(d=>{
      const todaysOpps=rows.filter(r=>String(r.date||r.Date||r.DATE)===d).map(r=>normTeam(r.opponent||r.Opponent||r.OPP));
      const remain=pool.filter(t=>!todaysOpps.includes(t));
      const r=rng(seedFromString(d+'|NLW|weighted'));
      const arr=remain.slice();
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(r()*(i+1));
        // ★ タイポ修正：正しいスワップ
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      // ここで arr を使った勝敗付与等を行う場合は追記
    });
  }

  const AVG=AB>0?(H/AB).toFixed(3):'.000'; const OBP=(AB+BB)>0?((H+BB)/(AB+BB)).toFixed(3):'.000';
  const SLG=AB>0?(TB/AB).toFixed(3):'.000'; const OPS=(parseFloat(OBP)+parseFloat(SLG)).toFixed(3);
  return {totals:{G,AB,H,HR,RBI,R,BB,TB,AVG,OBP,SLG,OPS,lastK,lastC,lastP,lastF},standings,logRows};
}

// ===== タイトル争いレンダリング（進行型） =====
function titleRanksProgress(totals){
  const games = totals.G || 0;
  const stars = simulateStars(games);

  const you = {name:"あなた", AVG: parseFloat(totals.AVG)||0, HR: totals.HR||0, RBI: totals.RBI||0, R: totals.R||0};

  function rankCategory(key, isRate=false){
    const pool = stars.map(s=>({name:s.name, v: isRate ? s.AVG : s[key]}));
    pool.push({name:you.name, v:isRate?you.AVG:you[key]});
    pool.sort((a,b)=>b.v - a.v);
    const pos = pool.findIndex(p=>p.name===you.name)+1;
    const top = pool[0];
    return {pos, topName:top.name, topVal:isRate? (isNaN(top.v)?".000":top.v.toFixed(3)) : top.v, you:isRate? (isNaN(you.AVG)?".000":you.AVG.toFixed(3)) : you[key]};
  }

  const rAvg = rankCategory("AVG", true);
  const rHr  = rankCategory("HR", false);
  const rRbi = rankCategory("RBI", false);
  const rR   = rankCategory("R", false);

  document.getElementById("rankAVGPos").textContent = `${rAvg.pos}位`;
  document.getElementById("rankAVGName").textContent = rAvg.topName;
  document.getElementById("rankAVGTop").textContent = rAvg.topVal;
  document.getElementById("rankAVGYou").textContent = rAvg.you;

  document.getElementById("rankHRPos").textContent = `${rHr.pos}位`;
  document.getElementById("rankHRName").textContent = rHr.topName;
  document.getElementById("rankHRTop").textContent = rHr.topVal;
  document.getElementById("rankHRYou").textContent = rHr.you;

  document.getElementById("rankRBIPos").textContent = `${rRbi.pos}位`;
  document.getElementById("rankRBIName").textContent = rRbi.topName;
  document.getElementById("rankRBITop").textContent = rRbi.topVal;
  document.getElementById("rankRBIYou").textContent = rRbi.you;

  document.getElementById("rankRPos").textContent = `${rR.pos}位`;
  document.getElementById("rankRName").textContent = rR.name;
  document.getElementById("rankRTop").textContent = rR.topVal;
  document.getElementById("rankRYou").textContent = rR.you;
}

// ===== NEXT GAME 自動 =====
function expandDays(schedule){ // duplicate for editor re-use
  const out=[];
  const start=new Date(schedule.start+"T00:00:00");
  let cur=new Date(start);
  schedule.series.forEach(s=>{
    for(let i=0;i<s.len;i++){
      out.push({date:cur.toISOString().slice(0,10), opp:s.opp, ha:s.ha});
      cur.setDate(cur.getDate()+1);
    }
    cur.setDate(cur.getDate()+1);
  });
  return out;
}
function findNextOpponent(lastDateStr){
  if(!EXPANDED || !EXPANDED.length) return null;
  const d = new Date(String(lastDateStr)+"T00:00:00");
  d.setDate(d.getDate()+1);
  const target = d.toISOString().slice(0,10);
  for(const g of EXPANDED){
    if(g.date >= target){ return g; }
  }
  return EXPANDED[0];
}

// ===== レンダリング =====
function render(totals, standings, logRows){
  ["G","AB","H","HR","RBI","R","BB","TB","AVG","OBP","SLG","OPS"].forEach(id=>{
    document.getElementById(id).textContent = totals[id] ?? "-";
  });
  document.getElementById("KCAL").textContent = totals.lastK ?? "-";
  document.getElementById("CARB").textContent = totals.lastC ?? "-";
  document.getElementById("PROT").textContent = totals.lastP ?? "-";
  document.getElementById("FAT").textContent  = totals.lastF ?? "-";

  const teams = Object.keys(standings).map(n=>({name:n, ...standings[n]}));
  teams.sort((a,b)=>{
    const pa = a.w/(a.w+a.l||1), pb = b.w/(b.w+b.l||1);
    if(pb!==pa) return pb-pa;
    return (b.w - a.w) || (a.l - b.l);
  });
  const leader = teams[0] || {w:0,l:0};
  const tbody = document.querySelector("#nlw tbody"); tbody.innerHTML="";
  teams.forEach((t,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}位</td><td>${t.name}</td><td>${t.w}</td><td>${t.l}</td>
      <td>${pct(t.w,t.l)}</td><td>${gb(leader.w,leader.l,t.w,t.l)}</td>`;
    tbody.appendChild(tr);
  });

  // game log
  const logBody = document.querySelector("#gameLog tbody"); logBody.innerHTML="";
  logRows.slice().reverse().forEach(g=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${g.date||""}</td><td>${g.opp||""}</td><td>${g.ds}-${g.os}</td><td>${g.res}</td>
      <td>${g.ab}-${g.h} HR${g.hr} RBI${g.rbi} R${g.rr} BB${g.bb}</td>
      <td>${g.kcal||0}/${g.carb||0}/${g.prot||0}/${g.fat||0}</td>
      <td>${g.breakfast||""}</td><td>${g.lunch||""}</td><td>${g.dinner||""}</td><td>${g.snack||""}</td><td>${g.drink||""}</td>
      <td>${g.comment||""}</td>`;
    logBody.appendChild(tr);
  });

  // title ranks（進行型）
  titleRanksProgress(totals);

  // NEXT GAME（自動）
  const latest = logRows[logRows.length-1];
  if(latest && latest.date){
    document.getElementById("latestGame").textContent = `${latest.date} vs ${latest.opp}（${latest.ds}-${latest.os}）`;
    const nx = findNextOpponent(String(latest.date));
    document.getElementById("nextAuto").textContent = nx ? `LAD ${nx.ha==='H'?'vs':'@'} ${nx.opp} / ${nx.date}` : "-";
  }else{
    document.getElementById("latestGame").textContent = "-";
    document.getElementById("nextAuto").textContent = "-";
  }
}

// ===== リフレッシュ＆初期化 =====
let SIM_ENABLED = true;
async function refresh(){
  try{
    const rows = await fetchSheet();
    const {totals, standings, logRows} = compute(rows, SIM_ENABLED);
    render(totals, standings, logRows);
  }catch(e){
    console.error(e);
    alert("シートの読み込みに失敗：公開設定 / SHEET_ID / シート名(games) をご確認ください。");
  }
}
function loadTargets(){
  try{
    const raw = localStorage.getItem('lad.targets.v1');
    return raw ? JSON.parse(raw) : {calLow:1900,calHigh:2100,carbLow:150,carbHigh:200,prot:120,fatLow:50,fatHigh:60};
  }catch(e){ return {calLow:1900,calHigh:2100,carbLow:150,carbHigh:200,prot:120,fatLow:50,fatHigh:60}; }
}
function saveTargets(t){
  localStorage.setItem('lad.targets.v1', JSON.stringify(t));
}
function fillTargets(t){
  document.getElementById("tCalLow").value = t.calLow;
  document.getElementById("tCalHigh").value= t.calHigh;
  document.getElementById("tCarbLow").value= t.carbLow;
  document.getElementById("tCarbHigh").value= t.carbHigh;
  document.getElementById("tProt").value   = t.prot;
  document.getElementById("tFatLow").value = t.fatLow;
  document.getElementById("tFatHigh").value= t.fatHigh;
}
function init(){
  // Targets
  const t = loadTargets(); fillTargets(t);
  document.getElementById("saveTargets").addEventListener("click", ()=>{
    const t = {
      calLow: Number(document.getElementById("tCalLow").value||0),
      calHigh:Number(document.getElementById("tCalHigh").value||0),
      carbLow:Number(document.getElementById("tCarbLow").value||0),
      carbHigh:Number(document.getElementById("tCarbHigh").value||0),
      prot:   Number(document.getElementById("tProt").value||0),
      fatLow: Number(document.getElementById("tFatLow").value||0),
      fatHigh:Number(document.getElementById("tFatHigh").value||0),
    };
    saveTargets(t);
    refresh();
  });
  document.getElementById("resetTargets").addEventListener("click", ()=>{
    const def = {calLow:1900,calHigh:2100,carbLow:150,carbHigh:200,prot:120,fatLow:50,fatHigh:60};
    saveTargets(def); fillTargets(def); refresh();
  });

  // Sim toggle
  const simToggle=document.getElementById("simToggle");
  if(simToggle){ SIM_ENABLED = simToggle.checked; simToggle.addEventListener("change", ()=>{ SIM_ENABLED = simToggle.checked; refresh(); }); }

  // JSON editor
  const ta=document.getElementById("schedJson");
  const apply=document.getElementById("apply");
  const msg=document.getElementById("applyMsg");
  ta.value = JSON.stringify(SCHEDULE, null, 2);
  apply.addEventListener("click", ()=>{
    try{
      const obj=JSON.parse(ta.value);
      if(!obj.start || !Array.isArray(obj.series)) throw new Error("start と series が必要です。");
      SCHEDULE=obj; EXPANDED=expandDays(SCHEDULE);
      msg.textContent="反映しました";
      setTimeout(()=>msg.textContent="", 2000);
      refresh();
    }catch(e){
      msg.textContent="エラー: "+e.message;
    }
  });

  refresh();
  setInterval(refresh, REFRESH_SEC*1000);
}
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
