<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ドジャース減量シーズン・ダッシュボード</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-2xl sm:text-3xl font-bold mb-4">ドジャース減量シーズン・ダッシュボード</h1>
    <p class="text-sm text-slate-600 mb-6">
      Googleシート <code>games</code> を読み込み：打撃・栄養・試合結果／NL西スタンディング（実力重みシミュレーション）／タイトル争い（進行型）／ターゲット評価／NEXT GAME（自動）／食事明細 を表示。
    </p>

    <!-- 通算打撃成績 -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">通算打撃成績</h2>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center">
        <div><div class="text-xs text-slate-500">試合</div><div id="sum-games" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">AB</div><div id="sum-ab" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">H</div><div id="sum-h" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">HR</div><div id="sum-hr" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">RBI</div><div id="sum-rbi" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">R</div><div id="sum-r" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">BB</div><div id="sum-bb" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">TB</div><div id="sum-tb" class="text-2xl font-semibold">-</div></div>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center mt-3">
        <div><div class="text-xs text-slate-500">AVG</div><div id="sum-avg" class="text-xl font-semibold">.000</div></div>
        <div><div class="text-xs text-slate-500">OBP</div><div id="sum-obp" class="text-xl font-semibold">.000</div></div>
        <div><div class="text-xs text-slate-500">SLG</div><div id="sum-slg" class="text-xl font-semibold">.000</div></div>
        <div><div class="text-xs text-slate-500">OPS</div><div id="sum-ops" class="text-xl font-semibold">.000</div></div>
      </div>
    </section>

    <!-- 栄養（直近日の合計） -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">栄養（直近日の合計）</h2>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center">
        <div><div class="text-xs text-slate-500">kcal</div><div id="nut-kcal" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">糖質</div><div id="nut-carb" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">P</div><div id="nut-prot" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">F</div><div id="nut-fat" class="text-2xl font-semibold">-</div></div>
      </div>
      <p class="text-xs text-slate-500 mt-2">ターゲット設定に基づき、最新日の評価を表示します。</p>
    </section>

    <!-- 試合ログ（食事明細つき） -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">試合ログ（食事明細つき）</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="games-table">
          <thead>
            <tr class="bg-slate-100 text-slate-700">
              <th class="px-3 py-2">日付</th><th class="px-3 py-2">対戦相手</th><th class="px-3 py-2">スコア</th><th class="px-3 py-2">結果</th>
              <th class="px-3 py-2">成績（AB-H HR RBI R BB）</th><th class="px-3 py-2">栄養(kcal/C/P/F)</th>
              <th class="px-3 py-2">朝食</th><th class="px-3 py-2">昼食</th><th class="px-3 py-2">夕食</th><th class="px-3 py-2">間食</th><th class="px-3 py-2">飲酒</th><th class="px-3 py-2">コメント</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ナ・リーグ西地区（Standings：実力重み付き） -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">ナ・リーグ西地区（Standings：実力重み付き） <span class="text-xs border px-2 py-0.5 rounded text-slate-500">非LAD試合は決定論シミュ</span></h2>
      <div class="flex items-center gap-2 mb-2">
        <label class="inline-flex items-center gap-2 text-sm"><input id="sim-toggle" type="checkbox" class="scale-110" checked> シミュレーションを有効にする</label>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="standings-table">
          <thead>
            <tr class="bg-slate-100 text-slate-700">
              <th class="px-3 py-2">順位</th><th class="px-3 py-2">チーム</th><th class="px-3 py-2">勝</th><th class="px-3 py-2">敗</th><th class="px-3 py-2">勝率</th><th class="px-3 py-2">GB</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- MLB タイトル争い（スター比較・進行型） -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">MLB タイトル争い（スター比較・進行型）</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="title-table">
          <thead>
            <tr class="bg-slate-100 text-slate-700">
              <th class="px-3 py-2">タイトル</th><th class="px-3 py-2">順位</th><th class="px-3 py-2">トップ選手</th><th class="px-3 py-2">トップ値</th><th class="px-3 py-2">あなた</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="text-xs text-slate-500 mt-2">※ スターの成績は想定進行。ジャッジHRはシーズン55〜58本に収束するよう調整。</p>
    </section>

    <!-- ターゲット設定（1日） -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">ターゲット設定（1日）</h2>
      <form id="target-form" class="grid grid-cols-2 sm:grid-cols-5 gap-3 max-w-3xl">
        <label class="text-sm">kcal <input id="t-kcal" type="number" class="border rounded px-2 py-1 w-full" placeholder="〜"></label>
        <label class="text-sm">糖質g <input id="t-carb" type="number" class="border rounded px-2 py-1 w-full" placeholder="〜"></label>
        <label class="text-sm">P目標g <input id="t-prot" type="number" class="border rounded px-2 py-1 w-full" placeholder=""></label>
        <label class="text-sm">脂質g <input id="t-fat" type="number" class="border rounded px-2 py-1 w-full" placeholder="〜"></label>
        <div class="flex items-end gap-2">
          <button id="btn-target-save" class="border rounded px-3 py-1.5">ターゲット保存</button>
          <button id="btn-target-reset" type="button" class="border rounded px-3 py-1.5">初期値</button>
        </div>
      </form>
      <p class="text-xs text-slate-500 mt-2">設定はブラウザの localStorage に保存。</p>
    </section>

    <!-- 最新試合 & NEXT GAME（自動） -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">最新試合 &amp; NEXT GAME（自動）</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="border rounded-xl p-4 bg-white"><div class="text-xs text-slate-500">最新試合</div><div id="latest-game" class="text-lg">-</div></div>
        <div class="border rounded-xl p-4 bg-white"><div class="text-xs text-slate-500">NEXT GAME</div><div id="next-game" class="text-lg">-</div></div>
      </div>
      <p class="text-xs text-slate-500 mt-2">内蔵スケジュールは2024年の実カード準拠。必要に応じて下のJSONから編集できます。</p>
    </section>

    <!-- スケジュール編集（JSON） -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">スケジュール編集（JSON）</h2>
      <details>
        <summary class="cursor-pointer select-none inline-flex items-center gap-2 border rounded px-3 py-1.5">開く / 閉じる</summary>
        <div class="mt-3">
          <textarea id="schedule-json" class="w-full h-48 border rounded p-2 font-mono text-xs"></textarea>
          <div class="mt-2"><button id="btn-apply-schedule" class="border rounded px-3 py-1.5">反映</button></div>
        </div>
      </details>
    </section>

    <div class="mt-8 text-xs text-slate-500">SHEET: <span id="sheet-pill">(未設定)</span> / 状態: <span id="status-pill">読み込み中...</span></div>
  </div>

  <!-- ===== 設定 ===== -->
  <script>
    const CONFIG = {
      SHEET_ID: "<YOUR_GOOGLE_SHEET_ID>", // games シートをウェブに公開 (CSV)
      SHEET_NAME: "games",
      TIMEZONE: "Asia/Tokyo",
    };
    const NLW = ["LAD","SFG","SDP","ARI","COL"]; // 5チーム固定
    const AL_POOL = ["SEA","TEX","HOU","LAA","OAK"]; // 補完用
    const PCT_3Y = { LAD:0.615, SFG:0.515, SDP:0.520, ARI:0.505, COL:0.420, SEA:0.540, TEX:0.540, HOU:0.570, LAA:0.430, OAK:0.350 };

    // タイトル争い（実名表記）
    const TITLE_PLAYERS = [
      { key:'avg', title:'首位打者', player:'Luis Arráez', team:'MIA', top:[.325,.340] },
      { key:'hr',  title:'本塁打王', player:'Aaron Judge', team:'NYY', top:[55,58] },
      { key:'rbi', title:'打点王',   player:'Yordan Alvarez', team:'HOU', top:[120,135] },
      { key:'r',   title:'得点王',   player:'Mookie Betts', team:'LAD', top:[120,135] },
    ];
  </script>

  <!-- ===== 2024実カード（最小サンプル：開幕〜SFG3戦） ===== -->
  <script id="schedule-embed" type="application/json">{
    "series": [
      {"id":"STL-20240328-31","dates":["2024-03-28","2024-03-29","2024-03-30","2024-03-31"],"opp":"STL","home":true},
      {"id":"SFG-20240401-03","dates":["2024-04-01","2024-04-02","2024-04-03"],"opp":"SFG","home":true}
    ]
  }</script>

  <!-- ===== ロジック ===== -->
  <script>
  const $ = (q)=>document.querySelector(q);
  const toISO = (d)=>{ const z = new Date(d.toLocaleString('en-US',{timeZone:CONFIG.TIMEZONE})); return z.toISOString().slice(0,10) };
  const hashStr=(s)=>{ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619)>>>0 } return h; };

  function decideWin(homeTeam, awayTeam, dateISO){
    const pHome=(PCT_3Y[homeTeam]??.5)+.015, pAway=(PCT_3Y[awayTeam]??.5)-.015;
    const u=(hashStr(`${dateISO}:${homeTeam}-${awayTeam}`)%10000)/10000;
    const homeWins = u < (pHome/(pHome+pAway));
    const base=(hashStr(`${dateISO}:${awayTeam}-${homeTeam}`)%7);
    const homeR=3+Math.floor(base/2)+(homeWins?1:0), awayR=3+(base%2)+(homeWins?0:1);
    return {homeWins,homeR,awayR};
  }

  async function fetchCSV(){
    const url=`https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(CONFIG.SHEET_NAME)}`;
    const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.text();
  }

  /* ▼ ヘッダー正規化対応パーサ（BOM/空白/大文字小文字/ハイフン対応）
     gamesヘッダー（正規）：
     date,opponent,dodgers_runs,opp_runs,result,AB,H,HR,RBI,R,BB,TB,comment,kcal_total,carb_total,prot_total,fat_total,breakfast,lunch,dinner,snack,drink */
  function parseCSV(text){
    const lines = text.split(/\r?\n/).filter(Boolean);
    if(!lines.length) return {header:[], rows:[]};

    const EXPECT_KEYS = [
      'date','opponent','dodgers_runs','opp_runs','result',
      'AB','H','HR','RBI','R','BB','TB','comment',
      'kcal_total','carb_total','prot_total','fat_total',
      'breakfast','lunch','dinner','snack','drink'
    ];

    const norm = s => (s||'').replace(/^\uFEFF/, '').trim().toLowerCase().replace(/[\s\-]+/g,'_');
    const MAP = {
      date:'date', opponent:'opponent', dodgers_runs:'dodgers_runs',
      opp_runs:'opp_runs', op_runs:'opp_runs', opponent_runs:'opp_runs',
      result:'result',
      ab:'AB', h:'H', hr:'HR', rbi:'RBI', r:'R', bb:'BB', tb:'TB',
      comment:'comment',
      kcal_total:'kcal_total', calories_total:'kcal_total',
      carb_total:'carb_total', carbohydrates_total:'carb_total',
      prot_total:'prot_total', protein_total:'prot_total',
      fat_total:'fat_total',
      breakfast:'breakfast', lunch:'lunch', dinner:'dinner',
      snack:'snack', drink:'drink'
    };

    const headerRaw = splitCSV(lines[0]).map(s=>s.replace(/^"|"$/g,''));
    const headerMap = headerRaw.map(h => MAP[norm(h)] || h); // 未知ヘッダーは素通し→無視される

    const rows = lines.slice(1).map(line => {
      const cols = splitCSV(line).map(c=>c.replace(/^"|"$/g,''));
      const rec = Object.fromEntries(EXPECT_KEYS.map(k=>[k,''])); // 既定キーを空で初期化
      headerMap.forEach((key, i) => {
        if(!key) return;
        if(!EXPECT_KEYS.includes(key)) return; // 未知ヘッダーは無視
        rec[key] = cols[i] ?? '';
      });
      return rec;
    });

    return {header: EXPECT_KEYS, rows};
  }

  function splitCSV(line){ const out=[]; let cur=''; let q=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ if(q && line[i+1]==='"'){cur+='"'; i++;} else q=!q; } else if(ch===',' && !q){ out.push(cur); cur=''; } else { cur+=ch; } } out.push(cur); return out; }

  function scheduleFromEmbed(){
    const json=$('#schedule-embed')?.textContent||'{}';
    const data=JSON.parse(json);
    const days=[];
    for(const s of (data.series||[])) for(const d of s.dates) days.push({date:d, opp:s.opp, home:!!s.home, seriesId:s.id});
    days.sort((a,b)=>a.date.localeCompare(b.date));
    return days;
  }

  function findNext(schedule, todayISO){ return schedule.find(g=>g.date>=todayISO); }
  function lastPlayed(rows){ return [...rows].reverse().find(r=> (r.dodgers_runs||r.opp_runs) ); }

  // ▼ games行のスコア欠損を決定論で補完（LADの対戦のみ）
  function fillMissingScores(rows, schedule, todayISO){
    for(const r of rows){
      if(!r.date || r.date>todayISO) continue; // 未来は補完しない
      if((r.dodgers_runs&&r.opp_runs&&r.result)) continue; // 既に埋まっている
      const sch = schedule.find(g=>g.date===r.date);
      const opp = r.opponent||sch?.opp||'SFG';
      const home = sch?.home ?? true;
      const res = home ? decideWin('LAD', opp, r.date
