<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ドジャース減量シーズン・ダッシュボード</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-2xl sm:text-3xl font-bold mb-4">ドジャース減量シーズン・ダッシュボード</h1>
    <p class="text-sm text-slate-600 mb-6">Googleシート <code>games</code> を読み込み：打撃・栄養・試合結果／NL西スタンディング（実力重みシミュレーション）／タイトル争い（進行型）／ターゲット評価／NEXT GAME（自動）／食事明細 を表示。</p>

    <!-- 通算打撃成績 -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">通算打撃成績</h2>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center">
        <div><div class="text-xs text-slate-500">試合</div><div id="sum-games" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">AB</div><div id="sum-ab" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">H</div><div id="sum-h" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">HR</div><div id="sum-hr" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">RBI</div><div id="sum-rbi" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">R</div><div id="sum-r" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">BB</div><div id="sum-bb" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">TB</div><div id="sum-tb" class="text-2xl font-semibold">-</div></div>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center mt-3">
        <div><div class="text-xs text-slate-500">AVG</div><div id="sum-avg" class="text-xl font-semibold">.000</div></div>
        <div><div class="text-xs text-slate-500">OBP</div><div id="sum-obp" class="text-xl font-semibold">.000</div></div>
        <div><div class="text-xs text-slate-500">SLG</div><div id="sum-slg" class="text-xl font-semibold">.000</div></div>
        <div><div class="text-xs text-slate-500">OPS</div><div id="sum-ops" class="text-xl font-semibold">.000</div></div>
      </div>
    </section>

    <!-- 栄養（直近日の合計） -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">栄養（直近日の合計）</h2>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center">
        <div><div class="text-xs text-slate-500">kcal</div><div id="nut-kcal" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">糖質</div><div id="nut-carb" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">P</div><div id="nut-prot" class="text-2xl font-semibold">-</div></div>
        <div><div class="text-xs text-slate-500">F</div><div id="nut-fat" class="text-2xl font-semibold">-</div></div>
      </div>
      <p class="text-xs text-slate-500 mt-2">ターゲット設定に基づき、最新日の評価を表示します。</p>
    </section>

    <!-- 試合ログ（食事明細つき） -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">試合ログ（食事明細つき）</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="games-table">
          <thead>
            <tr class="bg-slate-100 text-slate-700">
              <th class="px-3 py-2">日付</th><th class="px-3 py-2">対戦相手</th><th class="px-3 py-2">スコア</th><th class="px-3 py-2">結果</th>
              <th class="px-3 py-2">成績（AB-H HR RBI R BB）</th><th class="px-3 py-2">栄養(kcal/C/P/F)</th>
              <th class="px-3 py-2">朝食</th><th class="px-3 py-2">昼食</th><th class="px-3 py-2">夕食</th><th class="px-3 py-2">間食</th><th class="px-3 py-2">飲酒</th><th class="px-3 py-2">コメント</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ナ・リーグ西地区（Standings：実力重み付き） -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">ナ・リーグ西地区（Standings：実力重み付き） <span class="text-xs border px-2 py-0.5 rounded text-slate-500">非LAD試合は決定論シミュ</span></h2>
      <div class="flex items-center gap-2 mb-2">
        <label class="inline-flex items-center gap-2 text-sm"><input id="sim-toggle" type="checkbox" class="scale-110" checked> シミュレーションを有効にする</label>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="standings-table">
          <thead>
            <tr class="bg-slate-100 text-slate-700">
              <th class="px-3 py-2">順位</th><th class="px-3 py-2">チーム</th><th class="px-3 py-2">勝</th><th class="px-3 py-2">敗</th><th class="px-3 py-2">勝率</th><th class="px-3 py-2">GB</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- MLB タイトル争い（スター比較・進行型） -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">MLB タイトル争い（スター比較・進行型）</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="title-table">
          <thead>
            <tr class="bg-slate-100 text-slate-700">
              <th class="px-3 py-2">タイトル</th><th class="px-3 py-2">順位</th><th class="px-3 py-2">トップ選手</th><th class="px-3 py-2">トップ値</th><th class="px-3 py-2">あなた</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="text-xs text-slate-500 mt-2">※ スターの成績は2025年想定値ベースで「試合数に応じて」進行。ジャッジHRはシーズン55〜58本に収束するよう調整。</p>
    </section>

    <!-- ターゲット設定（1日） -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">ターゲット設定（1日）</h2>
      <form id="target-form" class="grid grid-cols-2 sm:grid-cols-5 gap-3 max-w-3xl">
        <label class="text-sm">kcal <input id="t-kcal" type="number" class="border rounded px-2 py-1 w-full" placeholder="〜"></label>
        <label class="text-sm">糖質g <input id="t-carb" type="number" class="border rounded px-2 py-1 w-full" placeholder="〜"></label>
        <label class="text-sm">P目標g <input id="t-prot" type="number" class="border rounded px-2 py-1 w-full" placeholder=""></label>
        <label class="text-sm">脂質g <input id="t-fat" type="number" class="border rounded px-2 py-1 w-full" placeholder="〜"></label>
        <div class="flex items-end gap-2">
          <button id="btn-target-save" class="border rounded px-3 py-1.5">ターゲット保存</button>
          <button id="btn-target-reset" type="button" class="border rounded px-3 py-1.5">初期値</button>
        </div>
      </form>
      <p class="text-xs text-slate-500 mt-2">設定はブラウザの localStorage に保存。</p>
    </section>

    <!-- 最新試合 & NEXT GAME（自動） -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">最新試合 &amp; NEXT GAME（自動）</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="border rounded-xl p-4 bg-white"><div class="text-xs text-slate-500">最新試合</div><div id="latest-game" class="text-lg">-</div></div>
        <div class="border rounded-xl p-4 bg-white"><div class="text-xs text-slate-500">NEXT GAME</div><div id="next-game" class="text-lg">-</div></div>
      </div>
      <p class="text-xs text-slate-500 mt-2">内蔵スケジュールは2024年の実カード準拠。必要に応じて下のJSONから編集できます。</p>
    </section>

    <!-- スケジュール編集（JSON） -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">スケジュール編集（JSON）</h2>
      <details>
        <summary class="cursor-pointer select-none inline-flex items-center gap-2 border rounded px-3 py-1.5">開く / 閉じる</summary>
        <div class="mt-3">
          <textarea id="schedule-json" class="w-full h-48 border rounded p-2 font-mono text-xs"></textarea>
          <div class="mt-2"><button id="btn-apply-schedule" class="border rounded px-3 py-1.5">反映</button></div>
        </div>
      </details>
    </section>

    <div class="mt-8 text-xs text-slate-500">SHEET: <span id="sheet-pill">(未設定)</span> / 状態: <span id="status-pill">読み込み中...</span></div>
  </div>

  <!-- ===== 設定 ===== -->
  <script>
    const CONFIG = {
      SHEET_ID: "1b3oO6nDY1d-jmP2cFchm7ld5PvKIr34vh0KXYYKxx8I", // games シートをウェブに公開 (CSV)
      SHEET_NAME: "games",
      TIMEZONE: "Asia/Tokyo",
    };
    const NLW = ["LAD","SFG","SDP","ARI","COL"];
    const AL_POOL = ["SEA","TEX","HOU","LAA","OAK"]; // 補完用
    const PCT_3Y = { LAD:0.615, SFG:0.515, SDP:0.520, ARI:0.505, COL:0.420, SEA:0.540, TEX:0.540, HOU:0.570, LAA:0.430, OAK:0.350 };
    const TITLE_PLAYERS = [
      { key:'avg', title:'首位打者', top:[.325,.340] },
      { key:'hr',  title:'本塁打王', top:[55,58] },
      { key:'rbi', title:'打点王',   top:[120,135] },
      { key:'r',   title:'得点王',   top:[120,135] },
    ];
  </script>

  <!-- ===== 2024実カード（最小サンプル：開幕〜SFG3戦） ===== -->
  <script id="schedule-embed" type="application/json">{
    "series": [
      {"id":"STL-20240328-31","dates":["2024-03-28","2024-03-29","2024-03-30","2024-03-31"],"opp":"STL","home":true},
      {"id":"SFG-20240401-03","dates":["2024-04-01","2024-04-02","2024-04-03"],"opp":"SFG","home":true}
    ]
  }</script>

  <!-- ===== ロジック ===== -->
  <script>
  const $ = (q)=>document.querySelector(q);
  const toISO = (d)=>{ const z = new Date(d.toLocaleString('en-US',{timeZone:CONFIG.TIMEZONE})); return z.toISOString().slice(0,10) };
  const hashStr=(s)=>{ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619)>>>0 } return h; };

  function decideWin(homeTeam, awayTeam, dateISO){
    const pHome=(PCT_3Y[homeTeam]??.5)+.015, pAway=(PCT_3Y[awayTeam]??.5)-.015;
    const u=(hashStr(`${dateISO}:${homeTeam}-${awayTeam}`)%10000)/10000;
    const homeWins = u < (pHome/(pHome+pAway));
    const base=(hashStr(`${dateISO}:${awayTeam}-${homeTeam}`)%7);
    const homeR=3+Math.floor(base/2)+(homeWins?1:0), awayR=3+(base%2)+(homeWins?0:1);
    return {homeWins,homeR,awayR};
  }

  async function fetchCSV(){
    const url=`https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(CONFIG.SHEET_NAME)}`;
    const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.text();
  }
  function parseCSV(text){
    const lines=text.split(/\r?\n/).filter(Boolean); if(!lines.length) return {header:[],rows:[]};
    const header=lines[0].split(',').map(s=>s.replace(/^"|"$/g,''));
    const rows=lines.slice(1).map(line=>{ const cols=splitCSV(line); const rec={}; header.forEach((h,i)=>rec[h]= (cols[i]??'').replace(/^"|"$/g,'')); return rec; });
    return {header,rows};
  }
  function splitCSV(line){ const out=[]; let cur=''; let q=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ if(q && line[i+1]==='"'){cur+='"'; i++;} else q=!q; } else if(ch===',' && !q){ out.push(cur); cur=''; } else { cur+=ch; } } out.push(cur); return out; }

  function scheduleFromEmbed(){
    const json=$('#schedule-embed')?.textContent||'{}';
    const data=JSON.parse(json);
    const days=[];
    for(const s of (data.series||[])) for(const d of s.dates) days.push({date:d, opp:s.opp, home:!!s.home, seriesId:s.id});
    days.sort((a,b)=>a.date.localeCompare(b.date));
    return days;
  }

  function findNext(schedule, todayISO){ return schedule.find(g=>g.date>=todayISO); }
  function lastPlayed(rows){ return [...rows].reverse().find(r=>r.dodgers_runs||r.opp_runs); }

  function renderLatestAndNext(rows, schedule, todayISO){
    const last=lastPlayed(rows); const next=findNext(schedule, todayISO);
    $('#latest-game').textContent = last? `${last.date} ${last.opponent} ${last.dodgers_runs}-${last.opp_runs} (${last.result||''})` : '-';
    $('#next-game').textContent   = next? `${next.date} vs ${next.opp} ${next.home?'(Home)':'(Away)'}` : '-';
  }

  function renderGameLog(rows){
    const tb=$('#games-table tbody'); tb.innerHTML='';
    for(const r of rows){
      const tr=document.createElement('tr');
      const score = (r.dodgers_runs||r.opp_runs)? `${r.dodgers_runs||0}-${r.opp_runs||0}` : '-';
      const result = r.result|| ( (r.dodgers_runs||0)>(r.opp_runs||0)? 'W':'L' );
      const bat = `${r.AB||0}-${r.H||0} ${r.HR||0} ${r.RBI||0} ${r.R||0} ${r.BB||0}`;
      const nut = `${r.kcal_total||0}/${r.carb_total||0}/${r.prot_total||0}/${r.fat_total||0}`;
      const cells=[r.date,r.opponent,score,result,bat,nut,r.breakfast||'',r.lunch||'',r.dinner||'',r.snack||'',r.drink||'',r.comment||''];
      for(const c of cells){ const td=document.createElement('td'); td.className='px-3 py-2 border-b border-slate-200'; td.textContent=c; tr.appendChild(td);} tb.appendChild(tr);
    }
  }

  function renderSum(rows){
    const nums=(k)=>rows.map(r=>+r[k]||0).reduce((a,b)=>a+b,0);
    const g = rows.filter(r=>r.AB||r.H||r.HR||r.BB||r.TB).length;
    const ab=nums('AB'), h=nums('H'), hr=nums('HR'), rbi=nums('RBI'), r=nums('R'), bb=nums('BB'), tb=nums('TB');
    const avg = ab? (h/ab).toFixed(3) : '0.000';
    const obp = (ab+bb)? ((h+bb)/(ab+bb)).toFixed(3) : '0.000';
    const slg = ab? (tb/ab).toFixed(3) : '0.000';
    const ops = (parseFloat(obp)+parseFloat(slg)).toFixed(3);
    $('#sum-games').textContent=g; $('#sum-ab').textContent=ab; $('#sum-h').textContent=h; $('#sum-hr').textContent=hr; $('#sum-rbi').textContent=rbi; $('#sum-r').textContent=r; $('#sum-bb').textContent=bb; $('#sum-tb').textContent=tb; $('#sum-avg').textContent=avg; $('#sum-obp').textContent=obp; $('#sum-slg').textContent=slg; $('#sum-ops').textContent=ops;
    // 直近日の栄養
    const byDate=[...rows].sort((a,b)=>a.date.localeCompare(b.date));
    const last = byDate[byDate.length-1];
    $('#nut-kcal').textContent=last?.kcal_total||'-';
    $('#nut-carb').textContent=last?.carb_total||'-';
    $('#nut-prot').textContent=last?.prot_total||'-';
    $('#nut-fat').textContent =last?.fat_total||'-';
  }

  function renderStandings(rows, schedule, todayISO, enableSim){
    const teams = { LAD:{W:0,L:0} , SFG:{W:0,L:0}, SDP:{W:0,L:0}, ARI:{W:0,L:0}, COL:{W:0,L:0} };
    // LAD 実績
    for(const r of rows){ if(!r.date||r.date>todayISO) continue; const w=(+r.dodgers_runs||0)>(+r.opp_runs||0); if(w) teams.LAD.W++; else teams.LAD.L++; }
    if(enableSim){
      const dates=[...new Set(schedule.filter(g=>g.date<=todayISO).map(g=>g.date))];
      for(const d of dates){
        const today = schedule.find(g=>g.date===d); if(!today) continue; const ladOpp=today.opp;
        const rest = NLW.filter(t=>t!=="LAD" && t!==ladOpp);
        const [t1,t2,t3]=rest; const al=["SEA","TEX","HOU","LAA","OAK"]; const alOpp=al[hashStr(d)%al.length];
        const pairs=[{home:t1,away:t2},{home:t3,away:alOpp}];
        for(const m of pairs){ const res=decideWin(m.home,m.away,d); const winTeam=res.homeWins?m.home:m.away; const loseTeam=res.homeWins?m.away:m.home; teams[winTeam]??={W:0,L:0}; teams[loseTeam]??={W:0,L:0}; teams[winTeam].W++; teams[loseTeam].L++; }
      }
    }
    const order=Object.entries(teams).map(([k,v])=>({team:k,...v,pct: (v.W+v.L? (v.W/(v.W+v.L)):0)})).sort((a,b)=>b.pct-a.pct);
    const lead=order[0]?.W-order[0]?.L; // for GB baseline (approx)
    const tb=$('#standings-table tbody'); tb.innerHTML='';
    order.forEach((t,i)=>{
      const gb = i===0? 0 : ((order[0].W - t.W) + (t.L - order[0].L))/2; // 近似
      const tr=document.createElement('tr');
      [i+1, t.team, t.W, t.L, t.pct.toFixed(3), gb.toFixed(1)].forEach(c=>{ const td=document.createElement('td'); td.className='px-3 py-2 border-b border-slate-200'; td.textContent=c; tr.appendChild(td);});
      tb.appendChild(tr);
    });
  }

  function renderTitle(){
    const tb=$('#title-table tbody'); tb.innerHTML='';
    TITLE_PLAYERS.forEach((t,i)=>{
      const p = 0.5; // シーズン中間の仮進捗（簡易）。必要あれば schedule から実試合数で割る。
      const top = Array.isArray(t.top)? (t.key==='avg'? (t.top[0]+(t.top[1]-t.top[0])*p).toFixed(3) : Math.round(t.top[0]+(t.top[1]-t.top[0])*p)) : t.top;
      const tr=document.createElement('tr');
      const your = i===1? 'あなたHR(累計)' : i===0? 'あなたAVG' : i===2? 'あなたRBI' : 'あなたR';
      [t.title, 1, 'スター', top, your].forEach(c=>{ const td=document.createElement('td'); td.className='px-3 py-2 border-b border-slate-200'; td.textContent=c; tr.appendChild(td);});
      tb.appendChild(tr);
    });
  }

  function loadTargets(){
    const get=(k,d)=> localStorage.getItem(k) ?? d;
    $('#t-kcal').value=get('t-kcal',''); $('#t-carb').value=get('t-carb',''); $('#t-prot').value=get('t-prot',''); $('#t-fat').value=get('t-fat','');
  }
  function saveTargets(e){ e.preventDefault(); ['t-kcal','t-carb','t-prot','t-fat'].forEach(id=>localStorage.setItem(id,$('#'+id).value||'')); }
  function resetTargets(){ ['t-kcal','t-carb','t-prot','t-fat'].forEach(id=>localStorage.removeItem(id)); loadTargets(); }

  async function main(){
    $('#sheet-pill').textContent = `${CONFIG.SHEET_ID}/${CONFIG.SHEET_NAME}`;
    loadTargets();
    try{
      const [csv, schedule] = await Promise.all([ fetchCSV(), Promise.resolve(scheduleFromEmbed()) ]);
      const {rows} = parseCSV(csv);
      const todayISO = toISO(new Date());
      renderSum(rows);
      renderGameLog(rows);
      renderLatestAndNext(rows, schedule, todayISO);
      renderStandings(rows, schedule, todayISO, $('#sim-toggle').checked);
      renderTitle();
      $('#status-pill').textContent='OK';
    }catch(e){ console.error(e); $('#status-pill').textContent='エラー'; }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    main();
    $('#sim-toggle').addEventListener('change', ()=>main());
    $('#btn-target-save').addEventListener('click', saveTargets);
    $('#btn-target-reset').addEventListener('click', resetTargets);
    // スケジュール編集UI
    const embed = document.getElementById('schedule-embed').textContent; $('#schedule-json').value = embed;
    document.getElementById('btn-apply-schedule').addEventListener('click', (e)=>{ e.preventDefault(); try{ document.getElementById('schedule-embed').textContent = $('#schedule-json').value; main(); }catch(err){ console.error('JSONエラー',err);} });
  });
  </script>
</body>
</html>
